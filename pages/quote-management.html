<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²¬ì ì„œ ê´€ë¦¬ - ë‹¤ì†”ë¬¼í™˜ê²½ì—°êµ¬ì†Œ</title>
    <style>
        /* =========================================
           1. ê¸°ì¡´ ê´€ë¦¬ì í˜ì´ì§€ UI (ê±´ë“œë¦¬ì§€ ì•ŠìŒ)
           ========================================= */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Pretendard', 'Malgun Gothic', sans-serif; background: #f3f4f6; padding: 20px; }
        .header { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 24px; color: #111827; }
        .header-actions { display: flex; gap: 12px; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: #667eea; color: white; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-success { background: #10b981; color: white; }
        
        .content { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 24px; }
        .filter-section { display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; }
        .filter-btn { padding: 8px 16px; border: 2px solid #e5e7eb; background: white; border-radius: 8px; cursor: pointer; font-size: 14px; transition: all 0.3s; }
        .filter-btn.active { background: #667eea; color: white; border-color: #667eea; }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; }
        th { background: #f9fafb; font-weight: 600; color: #374151; }
        .status-badge { padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 700; }
        .status-draft { background: #e5e7eb; color: #6b7280; }
        .status-sent { background: #dbeafe; color: #1e40af; }
        .status-converted { background: #d1fae5; color: #065f46; }
        .btn-small { padding: 6px 12px; font-size: 12px; border: none; border-radius: 6px; cursor: pointer; margin-right: 4px; }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ ìƒëµ (ê¸°ì¡´ê³¼ ë™ì¼) */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; overflow-y: auto; }
        .modal.show { display: flex; }
        .modal-content { background: white; border-radius: 12px; padding: 32px; max-width: 900px; width: 90%; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; }
        .form-group input, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; }
        .items-section { border: 1px solid #e5e7eb; padding: 16px; border-radius: 8px; margin: 20px 0; }
        .item-row { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 8px; margin-bottom: 8px; }
    </style>
</head>
<body>

    <div class="header">
        <h1>ğŸ“„ ê²¬ì ì„œ ê´€ë¦¬</h1>
        <div class="header-actions">
            <button class="btn btn-primary" onclick="openQuoteModal()">+ ê²¬ì ì„œ ì‘ì„±</button>
            <button class="btn btn-secondary" onclick="window.location.href='../dashboard-tabs.html'">ğŸ  ëŒ€ì‹œë³´ë“œ</button>
        </div>
    </div>

    <div class="content">
        <div class="filter-section">
            <button class="filter-btn active" onclick="filterQuotes('all')">ì „ì²´</button>
            <button class="filter-btn" onclick="filterQuotes('draft')">ì„ì‹œì €ì¥</button>
            <button class="filter-btn" onclick="filterQuotes('sent')">ë°œì†¡ì™„ë£Œ</button>
        </div>
        <table id="quoteTable">
            <thead>
                <tr>
                    <th>ê²¬ì ë²ˆí˜¸</th><th>ìˆ˜ì‹ ì²˜</th><th>ì‘ì„±ì¼</th><th>ê¸ˆì•¡</th><th>ìƒíƒœ</th><th>ì‘ì—…</th>
                </tr>
            </thead>
            <tbody id="quoteTableBody"></tbody>
        </table>
    </div>

    <div id="quoteModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom:20px;">ê²¬ì ì„œ ì‘ì„±</h2>
            <form id="quoteForm">
                <div class="form-row">
                    <div class="form-group"><label>ê²¬ì ë²ˆí˜¸</label><input type="text" id="quoteNumber" readonly></div>
                    <div class="form-group"><label>ì‘ì„±ì¼</label><input type="date" id="quoteDate" required></div>
                </div>
                <h3>ìˆ˜ì‹ ì²˜ ì •ë³´</h3>
                <div class="form-row">
                    <div class="form-group"><label>ìƒí˜¸</label><input type="text" id="clientName" required></div>
                    <div class="form-group"><label>ë‹´ë‹¹ì</label><input type="text" id="clientContact"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>ì—°ë½ì²˜</label><input type="text" id="clientPhone"></div>
                    <div class="form-group"><label>ì´ë©”ì¼</label><input type="email" id="clientEmail"></div>
                </div>
                <h3>ê²¬ì  ë‚´ì—­</h3>
                <div class="items-section">
                    <div id="itemsContainer"></div>
                    <button type="button" class="btn btn-success" onclick="addItem()" style="margin-top:8px;">+ í•­ëª© ì¶”ê°€</button>
                </div>
                <div style="background:#f9fafb; padding:15px; border-radius:8px; margin-top:15px; text-align:right;">
                    <div style="font-size:18px; font-weight:bold; color:#667eea;">í•©ê³„: <span id="grandTotal">0</span>ì›</div>
                </div>
                <div class="form-group" style="margin-top:15px;">
                    <label>ë¹„ê³ </label><textarea id="notes" rows="3"></textarea>
                </div>
                <div style="display:flex; gap:10px; margin-top:20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeQuoteModal()" style="flex:1;">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary" style="flex:1;">ì €ì¥ & PDF ìƒì„±</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ===============================================
        //  â–¼ [í•µì‹¬] ë°°ê²½ ì˜¤ë²„ë ˆì´ ë°©ì‹ PDF ìƒì„± í•¨ìˆ˜ â–¼
        // ===============================================
        function generateQuotePDF(quote) {
            const html = `
                <!DOCTYPE html>
                <html lang="ko">
                <head>
                    <meta charset="UTF-8">
                    <title>ê²¬ì ì„œ - ${quote.quoteNumber}</title>
                    <style>
                        @page { size: A4; margin: 0; }
                        body { 
                            margin: 0; padding: 0; 
                            width: 210mm; height: 297mm; /* A4 ì •ì‚¬ì´ì¦ˆ */
                            background-image: url('../assets/background.png'); /* ë°°ê²½ ì´ë¯¸ì§€ ë¡œë“œ */
                            background-size: 100% 100%;
                            background-repeat: no-repeat;
                            font-family: 'Pretendard', sans-serif;
                            position: relative; /* ì ˆëŒ€ ìœ„ì¹˜ ê¸°ì¤€ì  */
                            color: #111827;
                            -webkit-print-color-adjust: exact;
                        }
                        
                        /* 1. ë°ì´í„° ì˜¤ë²„ë ˆì´ (ìœ„ì¹˜ ì¡ê¸°) */
                        /* ë°°ê²½ ê·¸ë¦¼ ìœ„ì— ê¸€ìë§Œ ì–¹ìŠµë‹ˆë‹¤. ë¼ë²¨(ì œëª©)ì€ ë°°ê²½ì— ìˆìœ¼ë‹ˆ ìƒëµ! */
                        
                        /* ìš°ìƒë‹¨ í—¤ë” ì •ë³´ */
                        .header-data {
                            position: absolute;
                            top: 60px; right: 75px; /* ë°°ê²½ ìœ„ì¹˜ì— ë§ì¶° ì¡°ì • í•„ìš” */
                            text-align: right;
                            font-size: 14px;
                            line-height: 1.8;
                        }

                        /* ìˆ˜ì‹ ì²˜ ì •ë³´ (ì¢Œì¸¡ ìƒë‹¨ ë°•ìŠ¤) */
                        .client-data {
                            position: absolute;
                            top: 220px; left: 160px; /* ë¼ë²¨ ì˜†ìœ¼ë¡œ ìœ„ì¹˜ ì´ë™ */
                            font-size: 14px;
                            font-weight: 600;
                            line-height: 2.15; /* ì¤„ ê°„ê²© ë°°ê²½ê³¼ ë§ì¶¤ */
                        }

                        /* í•©ê³„ ê¸ˆì•¡ (ìˆ˜ì‹ ì²˜ ë°•ìŠ¤ í•˜ë‹¨) */
                        .total-amount {
                            position: absolute;
                            top: 365px; left: 100px; /* ìœ„ì¹˜ ì¡°ì • */
                            font-size: 18px; font-weight: 800; color: #111827;
                        }

                        /* í’ˆëª© í…Œì´ë¸” (íˆ¬ëª… í…Œì´ë¸”) */
                        .table-container {
                            position: absolute;
                            top: 515px; left: 75px;
                            width: 645px;
                        }
                        table { width: 100%; border-collapse: collapse; }
                        td { 
                            height: 40px; /* ë°°ê²½ ì¤„ ê°„ê²©ê³¼ ë™ì¼í•˜ê²Œ ì„¤ì • */
                            text-align: center; 
                            font-size: 14px; 
                            border: none; /* ì„  ì—†ìŒ (ë°°ê²½ì— ì´ë¯¸ ìˆìŒ) */
                            padding: 0 5px;
                        }
                        .col-name { text-align: left; padding-left: 10px; font-weight: 600; }
                        .col-money { text-align: right; padding-right: 10px; }

                        /* í•˜ë‹¨ í•©ê³„ ì˜ì—­ */
                        .footer-total {
                            position: absolute;
                            top: 920px; right: 80px;
                            font-size: 16px; font-weight: 700;
                            text-align: right;
                            line-height: 1.8;
                        }
                        
                        /* 2. í‘¸í„° í…ìŠ¤íŠ¸ (ìš”ì²­í•˜ì‹  ë¶€ë¶„!) */
                        /* ë¡œê³  ì˜†ì— ë“¤ì–´ê°ˆ í…ìŠ¤íŠ¸ë¥¼ ì—¬ê¸°ì„œ ì§ì ‘ ì”ë‹ˆë‹¤ */
                        .footer-text {
                            position: absolute;
                            bottom: 80px; /* ë°”ë‹¥ì—ì„œ ë„ì›€ */
                            left: 0; width: 100%;
                            text-align: center;
                            font-size: 13px;
                            color: #4b5563;
                            line-height: 1.6;
                        }
                        .company-title {
                            font-size: 16px; font-weight: 700; color: #111827; margin-bottom: 5px;
                        }

                        @media print { .no-print { display: none; } }
                    </style>
                </head>
                <body>
                    <div class="header-data">
                        <div>${quote.quoteNumber}</div>
                        <div>${new Date(quote.createdAt).toLocaleDateString('ko-KR')}</div>
                        <div>ê²¬ì ì¼ë¡œë¶€í„° 30ì¼</div>
                    </div>

                    <div class="client-data">
                        <div>${quote.clientName} ê·€í•˜</div>
                        <div>${quote.clientContact || '-'}</div>
                        <div>${quote.clientPhone || '-'}</div>
                    </div>

                    <div class="total-amount">
                        â‚© ${quote.grandTotal.toLocaleString()} 
                        <span style="font-size:14px; font-weight:normal;">(VAT í¬í•¨)</span>
                    </div>

                    <div class="table-container">
                        <table>
                            ${quote.items.map((item, index) => `
                            <tr>
                                <td width="8%">${index + 1}</td>
                                <td width="15%">ìˆ˜ì§ˆê²€ì‚¬</td>
                                <td class="col-name">${item.name}</td>
                                <td width="15%" class="col-money">${item.price.toLocaleString()}</td>
                                <td width="10%">${item.quantity}</td>
                                <td width="18%" class="col-money">${item.amount.toLocaleString()}</td>
                            </tr>
                            `).join('')}
                        </table>
                    </div>

                    <div class="footer-total">
                        <div>${quote.subtotal.toLocaleString()} ì›</div>
                        <div>${quote.vat.toLocaleString()} ì›</div>
                        <div style="font-size:20px; color:#111827; margin-top:5px;">${quote.grandTotal.toLocaleString()} ì›</div>
                    </div>

                    <div class="footer-text">
                        <div class="company-title">ì£¼ì‹íšŒì‚¬ ë‹¤ì†”ë¬¼í™˜ê²½ì—°êµ¬ì†Œ</div>
                        <div>ê²½ê¸°ë„ í•˜ë‚¨ì‹œ ì´ˆê´‘ì‚°ë‹¨ë¡œ 126, ìš°ì¼ë¹Œë”© 3ì¸µ</div>
                        <div>Tel. 031-772-4530 | Fax. 070-8677-0553 | E-mail. dasolwater@example.com</div>
                    </div>

                    <div class="no-print" style="position:fixed; top:20px; right:20px;">
                        <button onclick="window.print()" style="padding:10px 20px; background:#111827; color:white; border:none; border-radius:5px; cursor:pointer;">ğŸ–¨ï¸ ì¸ì‡„ / PDF ì €ì¥</button>
                    </div>
                </body>
                </html>
            `;
            const win = window.open('', '_blank', 'width=850,height=1000');
            win.document.write(html);
            win.document.close();
        }

        // --- (ì•„ë˜ëŠ” ê¸°ì¡´ ë¡œì§ê³¼ ë™ì¼í•©ë‹ˆë‹¤) ---
        let quotes = JSON.parse(localStorage.getItem('dasol_quotes') || '[]');
        
        function init() {
            renderTable();
            document.getElementById('quoteDate').valueAsDate = new Date();
            document.getElementById('quoteForm').onsubmit = (e) => {
                e.preventDefault();
                saveQuote();
            };
        }

        function openQuoteModal() {
            document.getElementById('quoteModal').style.display = 'flex';
            document.getElementById('itemsContainer').innerHTML = '';
            addItem();
            generateQuoteNumber();
        }
        function closeQuoteModal() { document.getElementById('quoteModal').style.display = 'none'; }
        
        function addItem() {
            const div = document.createElement('div');
            div.className = 'item-row';
            div.innerHTML = `
                <input type="text" placeholder="í’ˆëª…" class="i-name" required>
                <input type="number" placeholder="ë‹¨ê°€" class="i-price" onchange="calc(this)">
                <input type="number" placeholder="ìˆ˜ëŸ‰" class="i-qty" value="1" onchange="calc(this)">
                <input type="number" placeholder="ê¸ˆì•¡" class="i-amt" readonly>
                <button type="button" class="btn btn-secondary btn-small" onclick="this.parentElement.remove(); calcTotal();">ì‚­ì œ</button>
            `;
            document.getElementById('itemsContainer').appendChild(div);
        }

        function calc(el) {
            const row = el.parentElement;
            const p = Number(row.querySelector('.i-price').value);
            const q = Number(row.querySelector('.i-qty').value);
            row.querySelector('.i-amt').value = p * q;
            calcTotal();
        }

        function calcTotal() {
            let total = 0;
            document.querySelectorAll('.i-amt').forEach(input => total += Number(input.value));
            document.getElementById('grandTotal').innerText = Math.floor(total * 1.1).toLocaleString();
        }

        function saveQuote() {
            const items = [];
            let sub = 0;
            document.querySelectorAll('.item-row').forEach(row => {
                const p = Number(row.querySelector('.i-price').value);
                const q = Number(row.querySelector('.i-qty').value);
                items.push({
                    name: row.querySelector('.i-name').value,
                    price: p, quantity: q, amount: p*q
                });
                sub += p*q;
            });
            
            const q = {
                quoteNumber: document.getElementById('quoteNumber').value,
                createdAt: document.getElementById('quoteDate').value,
                clientName: document.getElementById('clientName').value,
                clientContact: document.getElementById('clientContact').value,
                clientPhone: document.getElementById('clientPhone').value,
                items: items,
                subtotal: sub,
                vat: Math.floor(sub * 0.1),
                grandTotal: Math.floor(sub * 1.1)
            };
            
            quotes.push(q);
            localStorage.setItem('dasol_quotes', JSON.stringify(quotes));
            generateQuotePDF(q);
            closeQuoteModal();
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('quoteTableBody');
            tbody.innerHTML = quotes.map((q, i) => `
                <tr>
                    <td>${q.quoteNumber}</td>
                    <td>${q.clientName}</td>
                    <td>${q.createdAt}</td>
                    <td>${q.grandTotal.toLocaleString()}ì›</td>
                    <td><span class="status-badge status-sent">ì™„ë£Œ</span></td>
                    <td><button class="btn-small btn-primary" onclick='generateQuotePDF(${JSON.stringify(q)})'>PDF</button></td>
                </tr>
            `).join('');
        }

        function generateQuoteNumber() {
            const date = new Date();
            const y = date.getFullYear().toString().slice(2);
            const m = (date.getMonth()+1).toString().padStart(2,'0');
            document.getElementById('quoteNumber').value = `ê²¬ì ${y}${m}-${(quotes.length+1).toString().padStart(4,'0')}`;
        }
        
        function filterQuotes(type) { renderTable(); } // í•„í„° ê¸°ëŠ¥ì€ ìƒëµë¨ (ì „ì²´ì¡°íšŒ)

        init();
    </script>
</body>
</html>
