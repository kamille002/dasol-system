<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹œë£Œ ë¼ë²¨ ì¶œë ¥ - ë‹¤ì†”ë¬¼í™˜ê²½ì—°êµ¬ì†Œ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
            background: #f3f4f6;
            padding: 20px;
        }
        .header {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            font-size: 24px;
            color: #111827;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 32px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 24px;
        }
        
        /* ë¼ë²¨ í”„ë¦¬ë·° */
        .label-preview {
            margin-top: 32px;
            padding: 24px;
            background: #f9fafb;
            border-radius: 8px;
            border: 2px dashed #e5e7eb;
        }
        .label-preview h3 {
            margin-bottom: 16px;
            color: #374151;
        }
        
        /* ì‹¤ì œ ë¼ë²¨ ìŠ¤íƒ€ì¼ (ì¸ì‡„ìš©) */
        @media print {
            body {
                background: white;
                padding: 0;
            }
            .header, .content, .no-print {
                display: none !important;
            }
            .print-labels {
                display: block !important;
            }
        }
        
        .print-labels {
            display: none;
        }
        
        .label-page {
            page-break-after: always;
            width: 100mm;
            height: 50mm;
            border: 1px solid #000;
            padding: 8mm;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .label-header {
            text-align: center;
            border-bottom: 2px solid #000;
            padding-bottom: 4mm;
            margin-bottom: 3mm;
        }
        
        .label-title {
            font-size: 16pt;
            font-weight: 700;
            margin-bottom: 2mm;
        }
        
        .label-body {
            font-size: 11pt;
            line-height: 1.6;
        }
        
        .label-row {
            display: flex;
            margin-bottom: 1.5mm;
        }
        
        .label-row strong {
            width: 35mm;
            font-weight: 700;
        }
        
        .sample-number {
            font-size: 14pt;
            font-weight: 700;
            text-align: center;
            padding: 2mm 0;
            background: #f0f0f0;
            border: 1px solid #000;
            margin-top: 2mm;
        }
    </style>
</head>
<body>
    <div class="header no-print">
        <h1>ğŸ·ï¸ ì‹œë£Œ ë¼ë²¨ ì¶œë ¥</h1>
        <button class="btn btn-secondary" onclick="window.location.href='../dashboard-final.html'">â† ëŒ€ì‹œë³´ë“œ</button>
    </div>

    <div class="content no-print">
        <h2 style="margin-bottom: 24px; font-size: 20px;">ë¼ë²¨ ì •ë³´ ì…ë ¥</h2>
        
        <form id="labelForm">
            <div class="form-group">
                <label>ì˜ë¢°ì„œ ì„ íƒ (ìë™ ì…ë ¥)</label>
                <select id="requestSelect" onchange="loadRequestData()">
                    <option value="">ì˜ë¢°ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                </select>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>ì‹œë£Œë²ˆí˜¸ *</label>
                    <input type="text" id="sampleNumber" placeholder="DS-20260210-001" required>
                </div>
                <div class="form-group">
                    <label>ì±„ìˆ˜ì¼ì *</label>
                    <input type="date" id="samplingDate" required>
                </div>
            </div>

            <div class="form-group">
                <label>ì˜ë¢°ì *</label>
                <input type="text" id="clientName" placeholder="í™ê¸¸ë™ ì•„íŒŒíŠ¸" required>
            </div>

            <div class="form-group">
                <label>ì±„ìˆ˜ì¥ì†Œ *</label>
                <input type="text" id="samplingLocation" placeholder="ì„œìš¸ì‹œ ê°•ë‚¨êµ¬..." required>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>ì‹œë£Œì¢…ë¥˜ *</label>
                    <select id="sampleType" required>
                        <option value="">ì„ íƒ</option>
                        <option value="ì €ìˆ˜ì¡°">ì €ìˆ˜ì¡°</option>
                        <option value="ì˜¥ë‚´ê¸‰ìˆ˜ê´€">ì˜¥ë‚´ê¸‰ìˆ˜ê´€</option>
                        <option value="ì •ìˆ˜ê¸°">ì •ìˆ˜ê¸°</option>
                        <option value="ìŒìš©ìˆ˜">ìŒìš©ìˆ˜</option>
                        <option value="ìƒí™œìš©ìˆ˜">ìƒí™œìš©ìˆ˜</option>
                        <option value="ì§€í•˜ìˆ˜">ì§€í•˜ìˆ˜</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ì‹œë£Œê°œìˆ˜</label>
                    <input type="number" id="sampleCount" min="1" value="1">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>ì±„ìˆ˜ì</label>
                    <input type="text" id="sampledBy" placeholder="ê¹€ì˜ì—…">
                </div>
                <div class="form-group">
                    <label>ì ‘ìˆ˜ì</label>
                    <input type="text" id="receivedBy" placeholder="ë°•ì‹¤í—˜">
                </div>
            </div>

            <button type="submit" class="btn-primary">ë¼ë²¨ ìƒì„± & ì¸ì‡„</button>
        </form>

        <div class="label-preview" id="labelPreview" style="display: none;">
            <h3>ë¼ë²¨ ë¯¸ë¦¬ë³´ê¸°</h3>
            <div id="previewContent"></div>
        </div>
    </div>

    <!-- ì¸ì‡„ìš© ë¼ë²¨ -->
    <div class="print-labels" id="printLabels"></div>

    <script>
        let requests = [];

        function init() {
            requests = JSON.parse(localStorage.getItem('dasol_requests') || '[]');
            
            // ì˜ë¢°ì„œ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
            const select = document.getElementById('requestSelect');
            select.innerHTML = '<option value="">ì˜ë¢°ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>' +
                requests.filter(r => r.status === 'sampling' || r.status === 'completed')
                    .map(r => `<option value="${r.id}">${r.requestNumber} - ${r.client.name}</option>`)
                    .join('');

            // ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì •
            document.getElementById('samplingDate').value = new Date().toISOString().split('T')[0];

            // í¼ ì œì¶œ ì´ë²¤íŠ¸
            document.getElementById('labelForm').addEventListener('submit', function(e) {
                e.preventDefault();
                generateLabels();
            });
        }

        function loadRequestData() {
            const requestId = document.getElementById('requestSelect').value;
            if (!requestId) return;

            const request = requests.find(r => r.id === requestId);
            if (!request) return;

            // ìë™ ì…ë ¥
            document.getElementById('clientName').value = request.client.name;
            document.getElementById('samplingLocation').value = request.sampling?.address || request.client.address;
            document.getElementById('sampleType').value = request.sample.type;
            document.getElementById('sampleCount').value = request.sample.count || 1;
            
            if (request.sampling?.scheduledTime) {
                document.getElementById('samplingDate').value = request.sampling.scheduledTime.split('T')[0];
            }

            // ì‹œë£Œë²ˆí˜¸ ìë™ ìƒì„±
            generateSampleNumber();
        }

        function generateSampleNumber() {
            const date = document.getElementById('samplingDate').value.replace(/-/g, '');
            const sequence = String(Math.floor(Math.random() * 1000)).padStart(3, '0');
            document.getElementById('sampleNumber').value = `DS-${date}-${sequence}`;
        }

        function generateLabels() {
            const sampleNumber = document.getElementById('sampleNumber').value;
            const samplingDate = document.getElementById('samplingDate').value;
            const clientName = document.getElementById('clientName').value;
            const samplingLocation = document.getElementById('samplingLocation').value;
            const sampleType = document.getElementById('sampleType').value;
            const sampleCount = parseInt(document.getElementById('sampleCount').value) || 1;
            const sampledBy = document.getElementById('sampledBy').value;
            const receivedBy = document.getElementById('receivedBy').value;

            const printContainer = document.getElementById('printLabels');
            let html = '';

            // ì‹œë£Œ ê°œìˆ˜ë§Œí¼ ë¼ë²¨ ìƒì„±
            for (let i = 0; i < sampleCount; i++) {
                const subSample = String.fromCharCode(65 + i); // A, B, C...
                const fullSampleNumber = sampleCount > 1 ? `${sampleNumber}-${subSample}` : sampleNumber;

                html += `
                    <div class="label-page">
                        <div class="label-header">
                            <div class="label-title">ë‹¤ì†”ë¬¼í™˜ê²½ì—°êµ¬ì†Œ</div>
                            <div style="font-size: 10pt;">ìˆ˜ì§ˆê²€ì‚¬ ì‹œë£Œ</div>
                        </div>
                        
                        <div class="label-body">
                            <div class="label-row">
                                <strong>ì‹œë£Œë²ˆí˜¸:</strong>
                                <span>${fullSampleNumber}</span>
                            </div>
                            <div class="label-row">
                                <strong>ì±„ìˆ˜ì¼ì:</strong>
                                <span>${formatDate(samplingDate)}</span>
                            </div>
                            <div class="label-row">
                                <strong>ì˜ë¢°ì:</strong>
                                <span>${clientName}</span>
                            </div>
                            <div class="label-row">
                                <strong>ì±„ìˆ˜ì¥ì†Œ:</strong>
                                <span style="font-size: 9pt;">${samplingLocation}</span>
                            </div>
                            <div class="label-row">
                                <strong>ì‹œë£Œì¢…ë¥˜:</strong>
                                <span>${sampleType}</span>
                            </div>
                            ${sampledBy ? `
                                <div class="label-row">
                                    <strong>ì±„ìˆ˜ì:</strong>
                                    <span>${sampledBy}</span>
                                </div>
                            ` : ''}
                            ${receivedBy ? `
                                <div class="label-row">
                                    <strong>ì ‘ìˆ˜ì:</strong>
                                    <span>${receivedBy}</span>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="sample-number">
                            ${fullSampleNumber}
                        </div>
                    </div>
                `;
            }

            printContainer.innerHTML = html;

            // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
            document.getElementById('previewContent').innerHTML = html;
            document.getElementById('labelPreview').style.display = 'block';

            // ì¸ì‡„
            if (confirm(`${sampleCount}ê°œì˜ ë¼ë²¨ì„ ì¸ì‡„í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                window.print();
            }
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR');
        }

        init();
    </script>
</body>
</html>
