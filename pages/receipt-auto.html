<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì ‘ìˆ˜ì¦ ìë™ ë°œê¸‰ - ë‹¤ì†”ë¬¼í™˜ê²½ì—°êµ¬ì†Œ</title>
    
    <!-- PDF ìƒì„± ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans KR', sans-serif;
            background: #f8f9fa;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        h1 {
            font-size: 28px;
            margin-bottom: 20px;
            color: #1f2937;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #1f2937;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        /* ì ‘ìˆ˜ì¦ ë¯¸ë¦¬ë³´ê¸° */
        #receiptPreview {
            background: white;
            padding: 40px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-family: 'Malgun Gothic', sans-serif;
        }

        .receipt-header {
            text-align: center;
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #1f2937;
        }

        .receipt-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .receipt-table th,
        .receipt-table td {
            border: 1px solid #1f2937;
            padding: 12px;
            text-align: left;
        }

        .receipt-table th {
            background: #f3f4f6;
            font-weight: 700;
        }

        .notice-section {
            margin-top: 30px;
            padding: 20px;
            background: #f9fafb;
            border-radius: 8px;
        }

        .notice-section h3 {
            margin-bottom: 12px;
            font-size: 16px;
        }

        .notice-section ul {
            margin-left: 20px;
        }

        .notice-section li {
            margin-bottom: 8px;
            font-size: 13px;
            line-height: 1.6;
        }

        .bank-info {
            margin-top: 20px;
            padding: 15px;
            background: #fef3c7;
            border-radius: 8px;
        }

        .contact-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 20px;
            font-size: 13px;
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #1f2937;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
        }

        .success-message {
            background: #d1fae5;
            border-left: 4px solid #10b981;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .error-message {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>ğŸ“„ ì ‘ìˆ˜ì¦ ìë™ ë°œê¸‰</h1>
            
            <div id="successMessage" class="success-message">
                <strong>âœ… ì ‘ìˆ˜ì¦ì´ ë°œê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤!</strong><br>
                ì´ë©”ì¼ë¡œ ìë™ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.
            </div>

            <div id="errorMessage" class="error-message">
                <strong>âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</strong><br>
                ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.
            </div>

            <!-- ì…ë ¥ í¼ -->
            <div class="form-group">
                <label>ì—…ì²´ëª… *</label>
                <input type="text" id="companyName" placeholder="ì˜ˆ: (ì£¼)ì´ì‚°" required>
            </div>

            <div class="form-group">
                <label>ì˜ë¢°ì *</label>
                <input type="text" id="clientName" placeholder="ì˜ˆ: í™ê¸¸ë™ ëŒ€ë¦¬" required>
            </div>

            <div class="form-group">
                <label>ì „í™”ë²ˆí˜¸</label>
                <input type="tel" id="clientPhone" placeholder="010-1234-5678">
            </div>

            <div class="form-group">
                <label>ì´ë©”ì¼ * (ì ‘ìˆ˜ì¦ ë°œì†¡ìš©)</label>
                <input type="email" id="clientEmail" placeholder="example@company.com" required>
            </div>

            <div class="form-group">
                <label>ì‹œë£Œëª… *</label>
                <textarea id="sampleName" rows="3" placeholder="ì˜ˆ: ìŠ¬ëŸ¬ì§€(ì„œì‚°)&#10;ìŠ¬ëŸ¬ì§€(ëŒ€ì‚°)&#10;ìŠ¬ëŸ¬ì§€(ì„±ì—°)"></textarea>
            </div>

            <div class="form-group">
                <label>ì‹œí—˜í•­ëª© *</label>
                <input type="text" id="testItems" placeholder="ì˜ˆ: í† ì–‘ ì „í•­ëª©" required>
            </div>

            <div class="form-group">
                <label>ì‹œë£Œ ê°œìˆ˜ *</label>
                <input type="number" id="sampleCount" value="3" min="1" required>
            </div>

            <div class="form-group">
                <label>ê³µê¸‰ê°€ì•¡ (ì›) *</label>
                <input type="number" id="supplyPrice" placeholder="1909091" required>
            </div>

            <div style="display: flex; gap: 15px; margin-top: 30px;">
                <button class="btn btn-primary" onclick="generateReceipt()" style="flex: 1;">
                    ğŸ“„ ì ‘ìˆ˜ì¦ ìƒì„± & ë°œì†¡
                </button>
                <button class="btn btn-secondary" onclick="previewReceipt()" style="flex: 1;">
                    ğŸ‘ï¸ ë¯¸ë¦¬ë³´ê¸°
                </button>
            </div>
        </div>

        <!-- ë¯¸ë¦¬ë³´ê¸° -->
        <div class="card" id="previewCard" style="display: none;">
            <h1>ğŸ“‹ ì ‘ìˆ˜ì¦ ë¯¸ë¦¬ë³´ê¸°</h1>
            <div id="receiptPreview"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-primary" onclick="downloadPDF()">
                    ğŸ’¾ PDF ë‹¤ìš´ë¡œë“œ
                </button>
            </div>
        </div>
    </div>

    <script>
        // í˜„ì¬ ë‚ ì§œ ê°€ì ¸ì˜¤ê¸°
        function getCurrentDate() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}ë…„ ${month}ì›” ${day}ì¼`;
        }

        // ì ‘ìˆ˜ë²ˆí˜¸ ìƒì„± (ì˜ˆ: 26-S1-0642)
        function generateReceiptNumber() {
            const now = new Date();
            const year = String(now.getFullYear()).slice(-2);
            const seq = String(Math.floor(Math.random() * 10000)).padStart(4, '0');
            return `${year}-S1-${seq}`;
        }

        // ì„±ì ì„œ ë²ˆí˜¸ ìƒì„±
        function generateCertNumber(receiptNum) {
            return `RIES-${receiptNum}`;
        }

        // ë¶€ê°€ì„¸ ê³„ì‚° (ê³µê¸‰ê°€ì•¡ì˜ 10%)
        function calculateVAT(supplyPrice) {
            return Math.round(supplyPrice * 0.1);
        }

        // ì ‘ìˆ˜ì¦ HTML ìƒì„±
        function createReceiptHTML(data) {
            const receiptNum = generateReceiptNumber();
            const certNum = generateCertNumber(receiptNum);
            const vat = calculateVAT(data.supplyPrice);
            const total = data.supplyPrice + vat;

            // ì‹œë£Œëª…ì„ ë°°ì—´ë¡œ ë³€í™˜
            const samples = data.sampleName.split('\n').filter(s => s.trim());

            return `
                <div class="receipt-header">ì ‘ ìˆ˜ ì¦</div>
                
                <table class="receipt-table">
                    <tr>
                        <th width="15%">ì—… ì²´ ëª…</th>
                        <td width="35%">${data.companyName}</td>
                        <th width="15%">ì ‘ìˆ˜ì¼ì</th>
                        <td width="35%">${getCurrentDate()}</td>
                    </tr>
                    <tr>
                        <th>ì˜ ë¢° ì</th>
                        <td>${data.clientName}</td>
                        <th>ë°œê¸‰ì¼ì</th>
                        <td>${getCurrentDate()}</td>
                    </tr>
                    <tr>
                        <th>ì „í™”ë²ˆí˜¸</th>
                        <td>${data.clientPhone}</td>
                        <th>ì˜ë¢°ëª©ì </th>
                        <td>ì¼ë°˜ê²€ì‚¬</td>
                    </tr>
                </table>

                <table class="receipt-table">
                    <tr>
                        <th width="20%">ì ‘ìˆ˜ë²ˆí˜¸</th>
                        <th width="30%">ì„±ì ì„œë°œê¸‰ ì˜ˆì •ë²ˆí˜¸</th>
                        <th width="20%">í’ˆ ëª©</th>
                        <th width="15%">ì ‘ìˆ˜ë‹´ë‹¹ì</th>
                        <th width="15%">ì‹œí—˜ë‹´ë‹¹ì</th>
                    </tr>
                    <tr>
                        <td>${receiptNum}</td>
                        <td>${certNum}</td>
                        <td>[ê²€ì‚¬ìˆ˜ìˆ˜ë£Œ] ${data.sampleCount} ê±´</td>
                        <td>í˜„í˜œì›</td>
                        <td>í•œë™ê· , ìœ ì„±í˜„</td>
                    </tr>
                </table>

                <table class="receipt-table" style="margin-top: 20px;">
                    <tr>
                        <th width="33%">ê³µê¸‰ê°€ì•¡</th>
                        <th width="33%">ë¶€ê°€ì„¸</th>
                        <th width="34%">ë¶„ì„ìˆ˜ìˆ˜ë£Œ(VATí¬í•¨)</th>
                    </tr>
                    <tr>
                        <td style="text-align: right; font-weight: 700;">${data.supplyPrice.toLocaleString()}ì›</td>
                        <td style="text-align: right; font-weight: 700;">${vat.toLocaleString()}ì›</td>
                        <td style="text-align: right; font-weight: 700; color: #667eea;">${total.toLocaleString()}ì›</td>
                    </tr>
                </table>

                <div class="notice-section">
                    <h3>â€» ì•ˆë‚´ì‚¬í•­</h3>
                    <ul>
                        <li>ì‹œí—˜ê²°ê³¼ëŠ” ì˜ë¢°ëª©ì  ì´ì™¸ì— ê´‘ê³  ë° ì†Œì†¡ ë“±ì˜ ëª©ì ìœ¼ë¡œ ì‚¬ìš©í•˜ì‹¤ ìˆ˜ ì—†ìœ¼ë©°, ê·¸ì— ë”°ë¥¸ ì±…ì„ì€ ë‹¹ì‚¬ì™€ ë¬´ê´€í•¨ì„ ì•Œë ¤ë“œë¦½ë‹ˆë‹¤.</li>
                        <li>ë³¸ ì„±ì ì„œë¥¼ ë¬´ë‹¨ ë„ìš©í•˜ê±°ë‚˜ ìœ„ì¡°í•  ê²½ìš° í˜•ì‚¬ê³ ë°œ, ì†í•´ë°°ìƒ ì†Œì†¡ ë“± í˜•ì‚¬ìƒ ì±…ì„ì„ ì§€ê²Œë©ë‹ˆë‹¤.</li>
                        <li>ì‹œí—˜ì„±ì ì„œ ë°œê¸‰ í›„ ë³€ê²½(ì‹œë£Œëª…, ì—…ì²´ëª…, ëŒ€í‘œì, ì£¼ì†Œ ë“± í¬í•¨) ë° ì·¨ì†ŒëŠ” ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
                        <li>ì‹œë£ŒëŠ” ì ‘ìˆ˜ì¼ë¡œë¶€í„° 24ì‹œê°„ ì´í›„ì—ëŠ” ì·¨ì†Œê°€ ë˜ì§€ ì•Šê³  ì…ê¸ˆì´ ë˜ì§€ ì•Šìœ¼ë©´ ì‚¬ë³¸ ë° ì›ë³¸ ì„±ì ì„œëŠ” ë°œí–‰ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
                        <li>ì‹œí—˜ì„±ì ì„œì˜ ì¬ë°œê¸‰ ê°€ëŠ¥ê¸°ê°„ì€ ì›ë³¸ì„±ì ì„œ ë°œê¸‰ì¼ë¡œë¶€í„° 3ë…„ ì´ë‚´ì´ê³  ì¬ë°œê¸‰ ìˆ˜ìˆ˜ë£Œ(10,000ì›, VATë³„ë„)ê°€ ë°œìƒí•©ë‹ˆë‹¤.</li>
                        <li>ì‹œë£ŒëŠ” ì ‘ìˆ˜ì¼ë¡œë¶€í„° 30ì¼ í›„ ìë™íê¸°ë©ë‹ˆë‹¤.</li>
                        <li>ì‹œí—˜ì„±ì ì„œëŠ” ì›ë³¸(ë“±ë³¸ í¬í•¨)ë§Œ ì¸ì •í•˜ë©°, ì‚¬ë³¸ ë° ì „ìì¸ì‡„ë³¸/íŒŒì¼ë³¸ì€ ì°¸ê³ ìš©ì´ë©° ì¸ì •ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
                    </ul>
                </div>

                <div class="bank-info">
                    <strong>ì…ê¸ˆ ê³„ì¢Œ ì•ˆë‚´</strong><br>
                    ì€í–‰ëª…: IBKê¸°ì—…ì€í–‰ | ê³„ì¢Œë²ˆí˜¸: 526-037619-01-016 | ì˜ˆê¸ˆì£¼: ë‹¤ì†”ë¬¼í™˜ê²½ì—°êµ¬ì†Œ
                </div>

                <div class="contact-info">
                    <div><strong>ì ‘ìˆ˜ë‹´ë‹¹ì:</strong> í˜„í˜œì› (031-699-6184)</div>
                    <div><strong>ì´ë©”ì¼:</strong> xz0313987@naver.com</div>
                </div>

                <table class="receipt-table" style="margin-top: 30px;">
                    <tr>
                        <th width="20%">ì‹œë£Œë²ˆí˜¸</th>
                        <th width="40%">ì‹œ ë£Œ ëª…</th>
                        <th width="30%">ì‹œí—˜í•­ëª©</th>
                        <th width="10%">ë¹„ê³ </th>
                    </tr>
                    ${samples.map((sample, index) => `
                        <tr>
                            <td>${receiptNum}.${String(index + 1).padStart(3, '0')}</td>
                            <td>${sample.trim()}</td>
                            <td>${data.testItems}</td>
                            <td></td>
                        </tr>
                    `).join('')}
                </table>

                <div class="footer">
                    <div class="logo">ë‹¤ì†”ë¬¼í™˜ê²½ì—°êµ¬ì†Œ</div>
                    <div style="margin-top: 10px; font-size: 13px; color: #6b7280;">
                        Fast, accurate and reliable analysis service
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; color: #9ca3af;">
                        ê²½ê¸°ë„ í•˜ë‚¨ì‹œ í•˜ë‚¨ëŒ€ë¡œ 947 í•˜ë‚¨í…Œí¬ë…¸ë°¸ë¦¬ U1ì„¼í„° Cë™ 1410í˜¸
                    </div>
                </div>
            `;
        }

        // ë¯¸ë¦¬ë³´ê¸°
        function previewReceipt() {
            const data = {
                companyName: document.getElementById('companyName').value,
                clientName: document.getElementById('clientName').value,
                clientPhone: document.getElementById('clientPhone').value,
                clientEmail: document.getElementById('clientEmail').value,
                sampleName: document.getElementById('sampleName').value,
                testItems: document.getElementById('testItems').value,
                sampleCount: parseInt(document.getElementById('sampleCount').value),
                supplyPrice: parseInt(document.getElementById('supplyPrice').value)
            };

            if (!data.companyName || !data.clientName || !data.sampleName || !data.testItems || !data.supplyPrice) {
                alert('í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const html = createReceiptHTML(data);
            document.getElementById('receiptPreview').innerHTML = html;
            document.getElementById('previewCard').style.display = 'block';
            
            // ìŠ¤í¬ë¡¤
            document.getElementById('previewCard').scrollIntoView({ behavior: 'smooth' });
        }

        // PDF ë‹¤ìš´ë¡œë“œ
        async function downloadPDF() {
            const element = document.getElementById('receiptPreview');
            const canvas = await html2canvas(element, { scale: 2 });
            
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            const imgData = canvas.toDataURL('image/png');
            const imgWidth = 210; // A4 width in mm
            const pageHeight = 297; // A4 height in mm
            const imgHeight = (canvas.height * imgWidth) / canvas.width;
            
            pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
            
            const receiptNum = generateReceiptNumber();
            pdf.save(`ì ‘ìˆ˜ì¦_${receiptNum}.pdf`);
        }

        // ì ‘ìˆ˜ì¦ ìƒì„± & ìë™ ë°œì†¡
        async function generateReceipt() {
            const data = {
                companyName: document.getElementById('companyName').value,
                clientName: document.getElementById('clientName').value,
                clientPhone: document.getElementById('clientPhone').value,
                clientEmail: document.getElementById('clientEmail').value,
                sampleName: document.getElementById('sampleName').value,
                testItems: document.getElementById('testItems').value,
                sampleCount: parseInt(document.getElementById('sampleCount').value),
                supplyPrice: parseInt(document.getElementById('supplyPrice').value)
            };

            if (!data.companyName || !data.clientName || !data.clientEmail || !data.sampleName || !data.testItems || !data.supplyPrice) {
                alert('í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // 1. PDF ìƒì„±
            const html = createReceiptHTML(data);
            document.getElementById('receiptPreview').innerHTML = html;
            document.getElementById('previewCard').style.display = 'block';
            
            // 2. PDF ë‹¤ìš´ë¡œë“œ
            await downloadPDF();

            // 3. ì´ë©”ì¼ ë°œì†¡ ì‹œë®¬ë ˆì´ì…˜ (ì‹¤ì œë¡œëŠ” ì„œë²„ì—ì„œ ì²˜ë¦¬)
            console.log('ì´ë©”ì¼ ë°œì†¡:', {
                to: data.clientEmail,
                subject: `[ë‹¤ì†”ë¬¼í™˜ê²½ì—°êµ¬ì†Œ] ì‹œë£Œ ì ‘ìˆ˜ì¦ - ${data.companyName}`,
                body: `
                    ${data.clientName}ë‹˜ ì•ˆë…•í•˜ì„¸ìš”,
                    
                    ì‹œë£Œê°€ ì •ìƒì ìœ¼ë¡œ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.
                    ì ‘ìˆ˜ì¦ì„ í™•ì¸í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.
                    
                    â–  ì ‘ìˆ˜ ì •ë³´
                    - ì—…ì²´ëª…: ${data.companyName}
                    - ì‹œë£Œ ê°œìˆ˜: ${data.sampleCount}ê±´
                    - ë¶„ì„ìˆ˜ìˆ˜ë£Œ: ${(data.supplyPrice + calculateVAT(data.supplyPrice)).toLocaleString()}ì›
                    
                    ì…ê¸ˆ í›„ ì„±ì ì„œê°€ ë°œê¸‰ë©ë‹ˆë‹¤.
                    
                    ê°ì‚¬í•©ë‹ˆë‹¤.
                    ë‹¤ì†”ë¬¼í™˜ê²½ì—°êµ¬ì†Œ
                `
            });

            // 4. ì„±ê³µ ë©”ì‹œì§€
            document.getElementById('successMessage').style.display = 'block';
            setTimeout(() => {
                document.getElementById('successMessage').style.display = 'none';
            }, 5000);

            // 5. ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
            const receiptNum = generateReceiptNumber();
            const receipts = JSON.parse(localStorage.getItem('dasol_receipts') || '[]');
            receipts.push({
                id: receiptNum,
                date: new Date().toISOString(),
                ...data
            });
            localStorage.setItem('dasol_receipts', JSON.stringify(receipts));

            alert('âœ… ì ‘ìˆ˜ì¦ì´ ë°œê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nê³ ê° ì´ë©”ì¼ë¡œ ìë™ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
    </script>
</body>
</html>
