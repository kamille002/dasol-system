<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜ë¢° ì ‘ìˆ˜ - ë‹¤ì†”ë¬¼í™˜ê²½ì—°êµ¬ì†Œ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
            background: #f3f4f6;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 40px;
        }
        h1 {
            font-size: 28px;
            color: #111827;
            margin-bottom: 8px;
        }
        .subtitle {
            color: #6b7280;
            margin-bottom: 32px;
        }
        .form-section {
            margin-bottom: 32px;
        }
        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: #374151;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e5e7eb;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }
        .required {
            color: #ef4444;
            margin-left: 4px;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        .checkbox-group label {
            margin: 0;
            cursor: pointer;
        }
        .date-range {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 12px;
            align-items: center;
        }
        .date-separator {
            color: #6b7280;
            font-weight: 600;
        }
        .auto-assign-box {
            background: #f0f9ff;
            border: 2px solid #3b82f6;
            border-radius: 8px;
            padding: 16px;
            margin-top: 24px;
        }
        .auto-assign-box h3 {
            font-size: 16px;
            color: #1e40af;
            margin-bottom: 8px;
        }
        .auto-assign-box p {
            font-size: 14px;
            color: #1e3a8a;
        }
        .assigned-person {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: white;
            padding: 8px 16px;
            border-radius: 6px;
            margin-top: 8px;
            font-weight: 600;
        }
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        .btn-secondary:hover {
            background: #4b5563;
        }
        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 32px;
            justify-content: flex-end;
        }
        .info-text {
            font-size: 13px;
            color: #6b7280;
            margin-top: 6px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
                <h1 style="margin: 0;">ğŸ“‹ ì˜ë¢° ì ‘ìˆ˜</h1>
                <p class="subtitle" style="margin: 5px 0 0 0;">ìƒˆë¡œìš´ ìˆ˜ì§ˆê²€ì‚¬ ì˜ë¢°ë¥¼ ì ‘ìˆ˜í•©ë‹ˆë‹¤</p>
            </div>
            <div style="display: flex; gap: 10px;">
                <button type="button" class="btn btn-secondary" onclick="history.back()" style="width: auto; padding: 10px 20px;">â† ë’¤ë¡œ</button>
                <button type="button" class="btn btn-secondary" onclick="window.location.href='../dashboard-tabs.html'" style="width: auto; padding: 10px 20px;">ğŸ  ëŒ€ì‹œë³´ë“œ</button>
            </div>
        </div>

        <form id="requestForm">
            <!-- ì‹œë£Œ ì •ë³´ -->
            <div class="form-section">
                <div class="section-title">ì‹œë£Œ ì •ë³´</div>
                
                <div class="form-group">
                    <label>ì‹œë£Œ ì¢…ë¥˜ <span class="required">*</span></label>
                    <select id="sampleType" required>
                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="ì €ìˆ˜ì¡°">ì €ìˆ˜ì¡°</option>
                        <option value="ì˜¥ë‚´ê¸‰ìˆ˜ê´€">ì˜¥ë‚´ê¸‰ìˆ˜ê´€</option>
                        <option value="ì •ìˆ˜ê¸°">ì •ìˆ˜ê¸°</option>
                        <option value="ì§€í•˜ìˆ˜">ì§€í•˜ìˆ˜</option>
                        <option value="ìê°€ì¸¡ì •">ìê°€ì¸¡ì •</option>
                        <option value="ì—”ì§€ë‹ˆì–´ë§">ì—”ì§€ë‹ˆì–´ë§</option>
                        <option value="ìš©ì—­">ìš©ì—­</option>
                        <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>ì±„ìˆ˜ ì§€ì  ì£¼ì†Œ <span class="required">*</span></label>
                    <input type="text" id="address" placeholder="ì˜ˆ: ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123" required>
                    <p class="info-text">ğŸ’¡ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ë©´ ë‹´ë‹¹ ì˜ì—…ì‚¬ì›ì´ ìë™ìœ¼ë¡œ ë°°ì •ë©ë‹ˆë‹¤</p>
                </div>
            </div>

            <!-- ì˜ë¢°ì ì •ë³´ -->
            <div class="form-section">
                <div class="section-title">ì˜ë¢°ì ì •ë³´</div>
                
                <div class="form-group">
                    <label>ì˜ë¢°ì ì„±ëª… <span class="required">*</span></label>
                    <input type="text" id="clientName" placeholder="ì˜ˆ: í™ê¸¸ë™" required>
                </div>

                <div class="form-group">
                    <label>ì˜ë¢°ì ì—°ë½ì²˜ <span class="required">*</span></label>
                    <input type="tel" id="clientPhone" placeholder="ì˜ˆ: 010-1234-5678" required>
                </div>
            </div>

            <!-- ì±„ìˆ˜ ì¼ì • -->
            <div class="form-section">
                <div class="section-title">ì±„ìˆ˜ ì¼ì •</div>
                
                <div class="form-group">
                    <label>ì±„ìˆ˜ í¬ë§ ê¸°ê°„ <span class="required">*</span></label>
                    <div class="date-range">
                        <input type="date" id="desiredDateStart" required>
                        <span class="date-separator">~</span>
                        <input type="date" id="desiredDateEnd">
                    </div>
                    <p class="info-text">ì¢…ë£Œì¼ì€ ì„ íƒì‚¬í•­ì…ë‹ˆë‹¤. íŠ¹ì • ë‚ ì§œë¥¼ ì›í•˜ì‹œë©´ ì‹œì‘ì¼ë§Œ ì…ë ¥í•˜ì„¸ìš”.</p>
                </div>

                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="flexibleSchedule">
                        <label for="flexibleSchedule">ì„ì˜ ì±„ìˆ˜ ê°€ëŠ¥ (ì˜ì—…ì‚¬ì›ì´ ì¼ì • ì¡°ìœ¨ ê°€ëŠ¥)</label>
                    </div>
                </div>

                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="isUrgent">
                        <label for="isUrgent" style="color: #ef4444; font-weight: 700;">ğŸ”´ ê¸´ê¸‰ ì˜ë¢°</label>
                    </div>
                </div>
            </div>

            <!-- ì ‘ìˆ˜ ë©”ëª¨ -->
            <div class="form-section">
                <div class="section-title">ì ‘ìˆ˜ ë©”ëª¨</div>
                
                <div class="form-group">
                    <label>ì˜ë¢°ì ìš”ì²­ì‚¬í•­</label>
                    <textarea id="notes" placeholder="ì˜ˆ: 2ì¸µ ì €ìˆ˜ì¡°ë„ í•¨ê»˜ ì±„ìˆ˜í•´ì£¼ì„¸ìš”&#10;ì…êµ¬ ë¹„ë°€ë²ˆí˜¸ëŠ” 1234ì…ë‹ˆë‹¤"></textarea>
                    <p class="info-text">ì˜ë¢°ìê°€ ì „ë‹¬í•œ íŠ¹ì´ì‚¬í•­ì´ë‚˜ ìš”ì²­ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”</p>
                </div>
            </div>

            <!-- ìë™ í• ë‹¹ ì •ë³´ -->
            <div class="auto-assign-box" id="autoAssignBox" style="display: none;">
                <h3>âœ… ë‹´ë‹¹ì ìë™ ë°°ì •</h3>
                <div class="assigned-person">
                    <span style="font-size: 20px;">ğŸ‘¤</span>
                    <span id="assignedPerson">-</span>
                </div>
                <p style="margin-top: 8px; font-size: 13px;">ì£¼ì†Œ ê¸°ë°˜ìœ¼ë¡œ ë‹´ë‹¹ ì˜ì—…ì‚¬ì›ì´ ìë™ ë°°ì •ë˜ì—ˆìŠµë‹ˆë‹¤</p>
            </div>

            <!-- ë²„íŠ¼ -->
            <div class="btn-group">
                <button type="button" class="btn btn-secondary" onclick="goBack()">ì·¨ì†Œ</button>
                <button type="submit" class="btn btn-primary">ì ‘ìˆ˜ ì™„ë£Œ</button>
            </div>
        </form>
    </div>

    <script>
        // í˜„ì¬ ë¡œê·¸ì¸ ì‚¬ìš©ì ì •ë³´
        const currentUser = JSON.parse(localStorage.getItem('dasol_session') || '{}');

        // ì£¼ì†Œ ì…ë ¥ ì‹œ ìë™ í• ë‹¹
        document.getElementById('address').addEventListener('input', function() {
            const address = this.value.trim();
            if (address.length > 5) {
                autoAssignSalesperson(address);
            }
        });

        // ìë™ í• ë‹¹ í•¨ìˆ˜
        function autoAssignSalesperson(address) {
            // ì£¼ì†Œì—ì„œ ì§€ì—­ ì¶”ì¶œ
            const region = extractRegion(address);
            
            if (!region) {
                document.getElementById('autoAssignBox').style.display = 'none';
                // ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ
                showWarning('ì£¼ì†Œì—ì„œ ì§€ì—­ì„ íŒŒì•…í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì£¼ì†Œë¥¼ "ì„œìš¸ ê°•ë‚¨êµ¬" í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ì‚¬ìš©ì DBì—ì„œ í•´ë‹¹ ì§€ì—­ ë‹´ë‹¹ì ì°¾ê¸°
            const users = JSON.parse(localStorage.getItem('dasol_users') || '[]');
            const assignedUser = users.find(user => 
                user.team === 'ì˜ì—…íŒ€' && 
                user.status === 'active' &&
                user.workRegions && 
                user.workRegions.some(r => region.includes(r) || r.includes(region))
            );

            if (assignedUser) {
                document.getElementById('autoAssignBox').style.display = 'block';
                document.getElementById('assignedPerson').textContent = 
                    `${assignedUser.name} (${assignedUser.position})`;
                
                // í¼ì— í• ë‹¹ ì •ë³´ ì €ì¥
                document.getElementById('requestForm').dataset.assignedTo = assignedUser.id;
                document.getElementById('requestForm').dataset.assignedName = assignedUser.name;
                
                // ê²½ê³  ìˆ¨ê¸°ê¸°
                hideWarning();
            } else {
                document.getElementById('autoAssignBox').style.display = 'none';
                document.getElementById('requestForm').dataset.assignedTo = '';
                
                // ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ
                showWarning(`âš ï¸ "${region}" ì§€ì—­ ë‹´ë‹¹ ì˜ì—…ì‚¬ì›ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ê±°ë‚˜ ë‹¤ë¥¸ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.`);
            }
        }

        // ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ
        function showWarning(message) {
            let warningBox = document.getElementById('warningBox');
            if (!warningBox) {
                warningBox = document.createElement('div');
                warningBox.id = 'warningBox';
                warningBox.style.cssText = `
                    background: #fef2f2;
                    border: 2px solid #ef4444;
                    border-radius: 8px;
                    padding: 16px;
                    margin-top: 12px;
                    color: #991b1b;
                    font-size: 14px;
                    font-weight: 600;
                `;
                document.getElementById('address').parentElement.appendChild(warningBox);
            }
            warningBox.textContent = message;
            warningBox.style.display = 'block';
        }

        // ê²½ê³  ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
        function hideWarning() {
            const warningBox = document.getElementById('warningBox');
            if (warningBox) {
                warningBox.style.display = 'none';
            }
        }

        // ì£¼ì†Œì—ì„œ ì§€ì—­ ì¶”ì¶œ
        function extractRegion(address) {
            // ë¨¼ì € ê°„ë‹¨í•œ í˜•íƒœ ì²´í¬: "ì„œìš¸ ê°•ë™êµ¬", "ê²½ê¸° ìˆ˜ì›ì‹œ"
            const simpleMatch = address.match(/^(ì„œìš¸|ë¶€ì‚°|ëŒ€êµ¬|ì¸ì²œ|ê´‘ì£¼|ëŒ€ì „|ìš¸ì‚°|ì„¸ì¢…|ê²½ê¸°|ê°•ì›|ì¶©ë¶|ì¶©ë‚¨|ì „ë¶|ì „ë‚¨|ê²½ë¶|ê²½ë‚¨|ì œì£¼)\s+([ê°€-í£]+[ì‹œêµ°êµ¬])/);
            if (simpleMatch) {
                return `${simpleMatch[1]} ${simpleMatch[2]}`;
            }
            
            // ë³µì¡í•œ í˜•íƒœ ì²´í¬: "ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë™êµ¬", "ê²½ê¸°ë„ ìˆ˜ì›ì‹œ"
            const complexMatch = address.match(/(ì„œìš¸|ë¶€ì‚°|ëŒ€êµ¬|ì¸ì²œ|ê´‘ì£¼|ëŒ€ì „|ìš¸ì‚°|ì„¸ì¢…|ê²½ê¸°|ê°•ì›|ì¶©ë¶|ì¶©ë‚¨|ì „ë¶|ì „ë‚¨|ê²½ë¶|ê²½ë‚¨|ì œì£¼)(?:íŠ¹ë³„ì‹œ|ê´‘ì—­ì‹œ|íŠ¹ë³„ìì¹˜ì‹œ|ë„|íŠ¹ë³„ìì¹˜ë„)?\s*([ê°€-í£]+[ì‹œêµ°êµ¬])/);
            
            if (complexMatch) {
                const city = complexMatch[1];
                const district = complexMatch[2];
                
                // "ì„œìš¸ ê°•ë‚¨êµ¬" í˜•ì‹ìœ¼ë¡œ ë°˜í™˜
                if (city === 'ì„œìš¸') return `ì„œìš¸ ${district}`;
                if (city === 'ê²½ê¸°') return `ê²½ê¸° ${district}`;
                return `${city} ${district}`;
            }
            
            return null;
        }

        // í¼ ì œì¶œ
        document.getElementById('requestForm').addEventListener('submit', function(e) {
            e.preventDefault();

            let assignedTo = this.dataset.assignedTo;
            let assignedName = this.dataset.assignedName;

            // ì‹œë£Œ ì¢…ë¥˜ ì²´í¬
            const sampleType = document.getElementById('sampleType').value;
            if (!sampleType) {
                alert('âŒ ì‹œë£Œ ì¢…ë¥˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                document.getElementById('sampleType').focus();
                return;
            }

            // ë‹´ë‹¹ìê°€ ì—†ìœ¼ë©´ "ë¯¸ë°°ì •"ìœ¼ë¡œ ì²˜ë¦¬
            if (!assignedTo) {
                if (!confirm('âš ï¸ ë‹´ë‹¹ ì˜ì—…ì‚¬ì›ì´ ìë™ ë°°ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n\n"ë¯¸ë°°ì •" ìƒíƒœë¡œ ì ‘ìˆ˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì˜ì—…íŒ€ì¥ì—ê²Œ ì•Œë¦¼ì´ ì „ì†¡ë©ë‹ˆë‹¤)')) {
                    return;
                }
                assignedTo = null;
                assignedName = 'ë¯¸ë°°ì •';
            }

            // ì˜ë¢° ë²ˆí˜¸ ìƒì„± (YY-MM-NNNNN)
            const now = new Date();
            const year = String(now.getFullYear()).slice(2);
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const requests = JSON.parse(localStorage.getItem('dasol_requests') || '[]');
            const todayRequests = requests.filter(r => r.requestNumber.startsWith(`${year}-${month}`));
            const sequence = String(todayRequests.length + 1).padStart(5, '0');
            const requestNumber = `${year}-${month}-${sequence}`;

            const newRequest = {
                id: 'REQ' + Date.now(),
                requestNumber: requestNumber,
                
                // ì‹œë£Œ ì •ë³´
                sampleType: sampleType,
                address: document.getElementById('address').value,
                
                // ì˜ë¢°ì ì •ë³´
                clientName: document.getElementById('clientName').value,
                clientPhone: document.getElementById('clientPhone').value,
                
                // ì±„ìˆ˜ ì¼ì •
                desiredDateStart: document.getElementById('desiredDateStart').value,
                desiredDateEnd: document.getElementById('desiredDateEnd').value || null,
                flexibleSchedule: document.getElementById('flexibleSchedule').checked,
                isUrgent: document.getElementById('isUrgent').checked,
                
                // ë©”ëª¨
                notes: document.getElementById('notes').value,
                
                // ìë™ ìƒì„± ì •ë³´
                createdAt: new Date().toISOString(),
                createdBy: currentUser.name || 'ì ‘ìˆ˜ì',
                createdById: currentUser.id || 'UNKNOWN',
                assignedTo: assignedTo,
                assignedName: assignedName,
                isUnassigned: assignedTo === null,  // ë¯¸ë°°ì • ì—¬ë¶€
                
                // ìƒíƒœ
                status: 'pending',  // pending, in-progress, completed
                sampledAt: null,
                completedAt: null
            };

            // ì €ì¥
            requests.push(newRequest);
            localStorage.setItem('dasol_requests', JSON.stringify(requests));

            const statusMessage = assignedTo ? 
                `âœ… ì˜ë¢°ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nì˜ë¢°ë²ˆí˜¸: ${requestNumber}\në‹´ë‹¹ì: ${assignedName}\nì‹œë£Œì¢…ë¥˜: ${sampleType}` :
                `âœ… ì˜ë¢°ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nì˜ë¢°ë²ˆí˜¸: ${requestNumber}\nìƒíƒœ: ë¯¸ë°°ì • (ì˜ì—…íŒ€ì¥ í™•ì¸ í•„ìš”)\nì‹œë£Œì¢…ë¥˜: ${sampleType}`;
            
            alert(statusMessage);
            
            // ëŒ€ì‹œë³´ë“œë¡œ ì´ë™
            window.location.href = '../dashboard-tabs.html';
        });

        function goBack() {
            if (confirm('ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì´ ì‚¬ë¼ì§‘ë‹ˆë‹¤. ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                window.location.href = '../dashboard-tabs.html';
            }
        }

        // ì˜¤ëŠ˜ ë‚ ì§œë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('desiredDateStart').value = today;
        document.getElementById('desiredDateStart').min = today;
        document.getElementById('desiredDateEnd').min = today;
    </script>
</body>
</html>
