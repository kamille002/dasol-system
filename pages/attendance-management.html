<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì§ì› ê·¼íƒœê´€ë¦¬ - ë‹¤ì†”ë¬¼í™˜ê²½ì—°êµ¬ì†Œ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans KR', sans-serif;
            background: #f8f9fa;
            padding: 20px;
        }

        .container { max-width: 1400px; margin: 0 auto; }

        .header {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 { font-size: 28px; }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary { background: white; color: #3b82f6; }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-warning { background: #f59e0b; color: white; }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-label {
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #1f2937;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .card h2 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #1f2937;
            border-bottom: 2px solid #3b82f6;
            padding-bottom: 10px;
        }

        .check-in-box {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
        }

        .check-in-box h2 {
            font-size: 24px;
            margin-bottom: 10px;
            border: none;
            color: white;
        }

        .time-display {
            font-size: 48px;
            font-weight: 700;
            margin: 20px 0;
        }

        .check-in-btn {
            padding: 20px 40px;
            font-size: 20px;
            font-weight: 700;
            background: white;
            color: #10b981;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .check-in-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }

        .check-in-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f9fafb;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #e5e7eb;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
        }

        tr:hover {
            background: #f9fafb;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-present { background: #d1fae5; color: #065f46; }
        .badge-absent { background: #fee2e2; color: #991b1b; }
        .badge-late { background: #fef3c7; color: #92400e; }
        .badge-vacation { background: #dbeafe; color: #1e40af; }
        .badge-pending { background: #fef3c7; color: #92400e; }
        .badge-approved { background: #d1fae5; color: #065f46; }
        .badge-rejected { background: #fee2e2; color: #991b1b; }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show { display: flex; }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-btn {
            background: #e5e7eb;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .vacation-days {
            background: #f0f9ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .vacation-days-row {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }

        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ‘¥ ì§ì› ê·¼íƒœê´€ë¦¬</h1>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="history.back()">â† ë’¤ë¡œ</button>
                <button class="btn btn-primary" onclick="window.location.href='../dashboard-tabs.html'">ğŸ  ëŒ€ì‹œë³´ë“œ</button>
            </div>
        </div>

        <!-- íƒ­ ë©”ë‰´ -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('checkin')">ì¶œí‡´ê·¼</div>
            <div class="tab" onclick="switchTab('vacation')">íœ´ê°€ ì‹ ì²­</div>
            <div class="tab" onclick="switchTab('overtime')">ì´ˆê³¼ê·¼ë¬´</div>
            <div class="tab" onclick="switchTab('records')">ê·¼ë¬´ ê¸°ë¡</div>
            <div class="tab" onclick="switchTab('approval')" id="approvalTab" style="display: none;">ìŠ¹ì¸ ê´€ë¦¬</div>
        </div>

        <!-- ì¶œí‡´ê·¼ íƒ­ -->
        <div id="checkin-tab" class="tab-content active">
            <div class="check-in-box">
                <h2>ğŸ“ ì˜¤ëŠ˜ì˜ ê·¼ë¬´</h2>
                <div class="time-display" id="currentTime">00:00:00</div>
                <div style="font-size: 18px; margin-bottom: 20px;" id="todayDate"></div>
                
                <div id="checkInStatus">
                    <button class="check-in-btn" onclick="checkIn()">
                        ğŸŸ¢ ì¶œê·¼í•˜ê¸°
                    </button>
                </div>
            </div>

            <!-- ì˜¤ëŠ˜ì˜ ì¶œê·¼ í˜„í™© (ê´€ë¦¬ìë§Œ) -->
            <div class="card" id="todayAttendance" style="display: none;">
                <h2>ğŸ“Š ì˜¤ëŠ˜ì˜ ì¶œê·¼ í˜„í™©</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">ì¶œê·¼</div>
                        <div class="stat-value" id="todayPresent">0ëª…</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ë¯¸ì¶œê·¼</div>
                        <div class="stat-value" id="todayAbsent">0ëª…</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ì§€ê°</div>
                        <div class="stat-value" id="todayLate">0ëª…</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">íœ´ê°€</div>
                        <div class="stat-value" id="todayVacation">0ëª…</div>
                    </div>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>ì´ë¦„</th>
                            <th>ë¶€ì„œ</th>
                            <th>ì¶œê·¼ì‹œê°„</th>
                            <th>í‡´ê·¼ì‹œê°„</th>
                            <th>ìƒíƒœ</th>
                        </tr>
                    </thead>
                    <tbody id="todayAttendanceTable"></tbody>
                </table>
            </div>
        </div>

        <!-- íœ´ê°€ ì‹ ì²­ íƒ­ -->
        <div id="vacation-tab" class="tab-content">
            <div class="card">
                <h2>ğŸ–ï¸ íœ´ê°€ ì‹ ì²­</h2>
                
                <div class="vacation-days">
                    <h3 style="margin-bottom: 10px;">ë‚´ ì—°ì°¨ í˜„í™©</h3>
                    <div class="vacation-days-row">
                        <span>ì´ ì—°ì°¨</span>
                        <strong id="totalVacation">15ì¼</strong>
                    </div>
                    <div class="vacation-days-row">
                        <span>ì‚¬ìš© ì—°ì°¨</span>
                        <strong id="usedVacation" style="color: #ef4444;">0ì¼</strong>
                    </div>
                    <div class="vacation-days-row" style="font-size: 18px; font-weight: 700; color: #3b82f6; border-top: 2px solid #3b82f6; padding-top: 10px; margin-top: 10px;">
                        <span>ì”ì—¬ ì—°ì°¨</span>
                        <strong id="remainVacation">15ì¼</strong>
                    </div>
                </div>

                <button class="btn btn-success" onclick="openVacationModal()">+ íœ´ê°€ ì‹ ì²­</button>
            </div>

            <div class="card">
                <h2>ğŸ“‹ ë‚´ íœ´ê°€ ì‹ ì²­ ë‚´ì—­</h2>
                <table>
                    <thead>
                        <tr>
                            <th>ì‹ ì²­ì¼</th>
                            <th>íœ´ê°€ ì¢…ë¥˜</th>
                            <th>ê¸°ê°„</th>
                            <th>ì¼ìˆ˜</th>
                            <th>ì‚¬ìœ </th>
                            <th>ìƒíƒœ</th>
                        </tr>
                    </thead>
                    <tbody id="myVacationsTable"></tbody>
                </table>
            </div>
        </div>

        <!-- ì´ˆê³¼ê·¼ë¬´ íƒ­ -->
        <div id="overtime-tab" class="tab-content">
            <div class="card">
                <h2>â° ì´ˆê³¼ê·¼ë¬´ ì‹ ì²­</h2>
                <button class="btn btn-success" onclick="openOvertimeModal()">+ ì´ˆê³¼ê·¼ë¬´ ì‹ ì²­</button>
            </div>

            <div class="card">
                <h2>ğŸ“‹ ë‚´ ì´ˆê³¼ê·¼ë¬´ ë‚´ì—­</h2>
                <table>
                    <thead>
                        <tr>
                            <th>ì‹ ì²­ì¼</th>
                            <th>ì´ˆê³¼ê·¼ë¬´ì¼</th>
                            <th>ì‹œì‘ì‹œê°„</th>
                            <th>ì¢…ë£Œì‹œê°„</th>
                            <th>ì´ ì‹œê°„</th>
                            <th>ì‚¬ìœ </th>
                            <th>ìƒíƒœ</th>
                        </tr>
                    </thead>
                    <tbody id="myOvertimeTable"></tbody>
                </table>
            </div>
        </div>

        <!-- ê·¼ë¬´ ê¸°ë¡ íƒ­ -->
        <div id="records-tab" class="tab-content">
            <div class="card">
                <h2>ğŸ“… ì›”ë³„ ê·¼ë¬´ ê¸°ë¡</h2>
                
                <div style="margin-bottom: 20px;">
                    <input type="month" id="recordMonth" onchange="loadMonthlyRecords()">
                </div>

                <div class="stats-grid" style="margin-bottom: 20px;">
                    <div class="stat-card">
                        <div class="stat-label">ì¶œê·¼ì¼ìˆ˜</div>
                        <div class="stat-value" id="monthlyPresent">0ì¼</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ì§€ê°</div>
                        <div class="stat-value" id="monthlyLate">0íšŒ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ì´ ê·¼ë¬´ì‹œê°„</div>
                        <div class="stat-value" id="monthlyHours">0H</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ì´ˆê³¼ê·¼ë¬´</div>
                        <div class="stat-value" id="monthlyOvertime">0H</div>
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="generateAttendanceReport()" style="margin-bottom: 20px; width: 100%;">
                    ğŸ“„ ê·¼íƒœê³„ ì¶œë ¥ (ì„¸ë¬´ì‚¬ ì œì¶œìš©)
                </button>

                <table>
                    <thead>
                        <tr>
                            <th>ë‚ ì§œ</th>
                            <th>ì¶œê·¼ì‹œê°„</th>
                            <th>í‡´ê·¼ì‹œê°„</th>
                            <th>ê·¼ë¬´ì‹œê°„</th>
                            <th>ìƒíƒœ</th>
                        </tr>
                    </thead>
                    <tbody id="monthlyRecordsTable"></tbody>
                </table>
            </div>
        </div>

        <!-- ìŠ¹ì¸ ê´€ë¦¬ íƒ­ (ê´€ë¦¬ì ì „ìš©) -->
        <div id="approval-tab" class="tab-content">
            <div class="card">
                <h2>ğŸ“Š ì „ì²´ ì§ì› ê·¼íƒœ ê´€ë¦¬</h2>
                
                <div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
                    <input type="month" id="allEmployeeMonth" style="padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                    <button class="btn btn-primary" onclick="generateAllEmployeeReport()" style="padding: 12px 24px;">
                        ğŸ“„ ì „ì²´ ì§ì› ê·¼íƒœí‘œ ì¶œë ¥ (ì„¸ë¬´ì‚¬ ì œì¶œìš©)
                    </button>
                </div>
            </div>
            
            <div class="card">
                <h2>ğŸ“ ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡</h2>
                <table>
                    <thead>
                        <tr>
                            <th>ì‹ ì²­ì¼</th>
                            <th>êµ¬ë¶„</th>
                            <th>ì‹ ì²­ì</th>
                            <th>ë¶€ì„œ</th>
                            <th>ë‚´ìš©</th>
                            <th>ê¸°ê°„/ì‹œê°„</th>
                            <th>ì‘ì—…</th>
                        </tr>
                    </thead>
                    <tbody id="pendingApprovalsTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- íœ´ê°€ ì‹ ì²­ ëª¨ë‹¬ -->
    <div id="vacationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ–ï¸ íœ´ê°€ ì‹ ì²­</h2>
                <button class="close-btn" onclick="closeVacationModal()">Ã—</button>
            </div>

            <form id="vacationForm">
                <div class="form-group">
                    <label>íœ´ê°€ ì¢…ë¥˜ *</label>
                    <select id="vacationType" required onchange="updateVacationDays()">
                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="ì—°ì°¨">ì—°ì°¨</option>
                        <option value="ë°˜ì°¨">ë°˜ì°¨ (ì˜¤ì „)</option>
                        <option value="ë°˜ì°¨ì˜¤í›„">ë°˜ì°¨ (ì˜¤í›„)</option>
                        <option value="ë³‘ê°€">ë³‘ê°€</option>
                        <option value="ê²½ì¡°ì‚¬">ê²½ì¡°ì‚¬</option>
                    </select>
                </div>

                <div class="grid-2">
                    <div class="form-group">
                        <label>ì‹œì‘ì¼ *</label>
                        <input type="date" id="vacationStart" required onchange="updateVacationDays()">
                    </div>
                    <div class="form-group">
                        <label>ì¢…ë£Œì¼ *</label>
                        <input type="date" id="vacationEnd" required onchange="updateVacationDays()">
                    </div>
                </div>

                <div class="vacation-days" style="background: #fef3c7;">
                    <div class="vacation-days-row">
                        <span>ì‹ ì²­ ì¼ìˆ˜</span>
                        <strong id="requestDays" style="color: #d97706;">0ì¼</strong>
                    </div>
                </div>

                <div class="form-group">
                    <label>ì‚¬ìœ  *</label>
                    <textarea id="vacationReason" rows="3" required></textarea>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-success" style="flex: 1;">ì‹ ì²­</button>
                    <button type="button" class="btn btn-primary" onclick="closeVacationModal()" style="flex: 1;">ì·¨ì†Œ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ì´ˆê³¼ê·¼ë¬´ ì‹ ì²­ ëª¨ë‹¬ -->
    <div id="overtimeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>â° ì´ˆê³¼ê·¼ë¬´ ì‹ ì²­</h2>
                <button class="close-btn" onclick="closeOvertimeModal()">Ã—</button>
            </div>

            <form id="overtimeForm">
                <div class="form-group">
                    <label>ì´ˆê³¼ê·¼ë¬´ì¼ *</label>
                    <input type="date" id="overtimeDate" required>
                </div>

                <div class="grid-2">
                    <div class="form-group">
                        <label>ì‹œì‘ì‹œê°„ *</label>
                        <input type="time" id="overtimeStart" required onchange="calculateOvertimeHours()">
                    </div>
                    <div class="form-group">
                        <label>ì¢…ë£Œì‹œê°„ *</label>
                        <input type="time" id="overtimeEnd" required onchange="calculateOvertimeHours()">
                    </div>
                </div>

                <div class="vacation-days" style="background: #fef3c7;">
                    <div class="vacation-days-row">
                        <span>ì´ˆê³¼ê·¼ë¬´ ì‹œê°„</span>
                        <strong id="overtimeHours" style="color: #d97706;">0ì‹œê°„</strong>
                    </div>
                </div>

                <div class="form-group">
                    <label>ì‚¬ìœ  *</label>
                    <textarea id="overtimeReason" rows="3" required></textarea>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-success" style="flex: 1;">ì‹ ì²­</button>
                    <button type="button" class="btn btn-primary" onclick="closeOvertimeModal()" style="flex: 1;">ì·¨ì†Œ</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentUser = null;
        let attendances = [];
        let vacations = [];
        let overtimes = [];

        window.addEventListener('load', () => {
            currentUser = JSON.parse(localStorage.getItem('dasol_session') || 'null');
            if (!currentUser) {
                alert('âš ï¸ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!');
                window.location.href = '../index.html';
                return;
            }

            loadData();
            initializePage();
            updateClock();
            setInterval(updateClock, 1000);

            // ê´€ë¦¬ìë©´ ìŠ¹ì¸ ê´€ë¦¬ íƒ­ í‘œì‹œ
            if (currentUser.isAdmin) {
                document.getElementById('approvalTab').style.display = 'block';
                document.getElementById('todayAttendance').style.display = 'block';
            }

            // ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì •
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('recordMonth').value = today.substring(0, 7);
            
            loadMonthlyRecords();
            checkTodayAttendance();
        });

        function loadData() {
            attendances = JSON.parse(localStorage.getItem('dasol_attendance') || '[]');
            vacations = JSON.parse(localStorage.getItem('dasol_vacations') || '[]');
            overtimes = JSON.parse(localStorage.getItem('dasol_overtimes') || '[]');
        }

        function saveData() {
            localStorage.setItem('dasol_attendance', JSON.stringify(attendances));
            localStorage.setItem('dasol_vacations', JSON.stringify(vacations));
            localStorage.setItem('dasol_overtimes', JSON.stringify(overtimes));
            
            // íœ´ê°€ê°€ ìŠ¹ì¸ë˜ë©´ ë‹¬ë ¥ì—ë„ ì €ì¥
            syncCalendar();
        }

        function initializePage() {
            const today = new Date();
            document.getElementById('todayDate').textContent = 
                `${today.getFullYear()}ë…„ ${today.getMonth() + 1}ì›” ${today.getDate()}ì¼ ${['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][today.getDay()]}ìš”ì¼`;
        }

        function updateClock() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            document.getElementById('currentTime').textContent = `${hours}:${minutes}:${seconds}`;
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`${tab}-tab`).classList.add('active');

            if (tab === 'vacation') {
                updateVacationInfo();
                renderMyVacations();
            } else if (tab === 'overtime') {
                renderMyOvertime();
            } else if (tab === 'approval') {
                renderPendingApprovals();
            }
        }

        function checkTodayAttendance() {
            const today = new Date().toISOString().split('T')[0];
            const todayRecord = attendances.find(a => 
                a.userId === currentUser.id && a.date === today
            );

            if (todayRecord) {
                if (todayRecord.checkOut) {
                    document.getElementById('checkInStatus').innerHTML = `
                        <div style="background: white; color: #3b82f6; padding: 20px; border-radius: 8px;">
                            <h3>âœ… í‡´ê·¼ ì™„ë£Œ</h3>
                            <p style="margin-top: 10px;">ì¶œê·¼: ${todayRecord.checkIn}</p>
                            <p>í‡´ê·¼: ${todayRecord.checkOut}</p>
                        </div>
                    `;
                } else {
                    document.getElementById('checkInStatus').innerHTML = `
                        <div style="margin-bottom: 20px; background: white; color: #10b981; padding: 15px; border-radius: 8px;">
                            <p>âœ… ì¶œê·¼: ${todayRecord.checkIn}</p>
                        </div>
                        <button class="check-in-btn" onclick="checkOut()" style="background: #ef4444; color: white;">
                            ğŸ”´ í‡´ê·¼í•˜ê¸°
                        </button>
                    `;
                }
            }

            // ê´€ë¦¬ììš© ì˜¤ëŠ˜ ì¶œê·¼ í˜„í™©
            if (currentUser.isAdmin) {
                updateTodayStats();
            }
        }

        function checkIn() {
            const today = new Date().toISOString().split('T')[0];
            const now = new Date();
            const time = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            
            // ì§€ê° ì²´í¬ (09:00 ì´í›„)
            const isLate = now.getHours() > 9 || (now.getHours() === 9 && now.getMinutes() > 0);
            
            // ì˜ì—…íŒ€ì´ë©´ GPS ìœ„ì¹˜ ìˆ˜ì§‘
            const isSalesTeam = currentUser.team && (currentUser.team.includes('ì˜ì—…') || currentUser.role === 'sales');
            
            if (isSalesTeam) {
                // GPS ê¶Œí•œ ìš”ì²­
                if (!navigator.geolocation) {
                    alert('âš ï¸ ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    return;
                }
                
                const confirmGPS = confirm('ğŸ“ ì˜ì—…íŒ€ ì¶œí‡´ê·¼ì€ ìœ„ì¹˜ ì •ë³´ë¥¼ ê¸°ë¡í•©ë‹ˆë‹¤.\nìœ„ì¹˜ ì •ë³´ ìˆ˜ì§‘ì— ë™ì˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
                if (!confirmGPS) {
                    return;
                }
                
                // ìœ„ì¹˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        processCheckIn(position.coords.latitude, position.coords.longitude, time, isLate);
                    },
                    (error) => {
                        console.error('GPS ì—ëŸ¬:', error);
                        const retry = confirm('âš ï¸ ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nìœ„ì¹˜ ì—†ì´ ì¶œê·¼í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
                        if (retry) {
                            processCheckIn(null, null, time, isLate);
                        }
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                // ì¼ë°˜ ì§ì›ì€ ìœ„ì¹˜ ì •ë³´ ì—†ì´ ì¶œê·¼
                processCheckIn(null, null, time, isLate);
            }
        }
        
        function processCheckIn(latitude, longitude, time, isLate) {
            const today = new Date().toISOString().split('T')[0];
            
            const attendance = {
                id: `ATT-${Date.now()}`,
                userId: currentUser.id,
                userName: currentUser.name,
                userTeam: currentUser.team,
                date: today,
                checkIn: time,
                checkOut: null,
                status: isLate ? 'late' : 'present',
                createdAt: new Date().toISOString()
            };
            
            // GPS ì •ë³´ ì¶”ê°€ (ì˜ì—…íŒ€ë§Œ)
            if (latitude && longitude) {
                attendance.checkInLocation = {
                    latitude: latitude,
                    longitude: longitude,
                    type: 'field',
                    timestamp: new Date().toISOString()
                };
                
                // ì—­ì§€ì˜¤ì½”ë”© ì‹œë„ (ë¹„ë™ê¸°)
                reverseGeocode(latitude, longitude).then(address => {
                    attendance.checkInLocation.address = address;
                    const index = attendances.findIndex(a => a.id === attendance.id);
                    if (index !== -1) {
                        attendances[index] = attendance;
                        saveData();
                    }
                }).catch(err => {
                    console.error('ì—­ì§€ì˜¤ì½”ë”© ì‹¤íŒ¨:', err);
                });
            } else {
                attendance.checkInLocation = {
                    type: 'office'
                };
            }
            
            attendances.push(attendance);
            saveData();
            checkTodayAttendance();
            
            const locationMsg = attendance.checkInLocation.type === 'field' 
                ? '\nğŸ“ ì™¸ê·¼ ìœ„ì¹˜ ê¸°ë¡ë¨' 
                : '\nğŸ¢ íšŒì‚¬ ì¶œê·¼';
            
            alert(`âœ… ì¶œê·¼ ì™„ë£Œ!\nì‹œê°„: ${time}${isLate ? '\nâš ï¸ ì§€ê° ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.' : ''}${locationMsg}`);
        }

        function checkOut() {
            const today = new Date().toISOString().split('T')[0];
            const now = new Date();
            const time = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            
            const todayRecord = attendances.find(a => 
                a.userId === currentUser.id && a.date === today && !a.checkOut
            );
            
            if (!todayRecord) {
                alert('âš ï¸ ì¶œê·¼ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤!');
                return;
            }
            
            // ì˜ì—…íŒ€ì´ë©´ GPS ìœ„ì¹˜ ìˆ˜ì§‘
            const isSalesTeam = currentUser.team && (currentUser.team.includes('ì˜ì—…') || currentUser.role === 'sales');
            
            if (isSalesTeam) {
                // GPS ê¶Œí•œ ìš”ì²­
                if (!navigator.geolocation) {
                    alert('âš ï¸ ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    processCheckOut(todayRecord, null, null, time);
                    return;
                }
                
                // ìœ„ì¹˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        processCheckOut(todayRecord, position.coords.latitude, position.coords.longitude, time);
                    },
                    (error) => {
                        console.error('GPS ì—ëŸ¬:', error);
                        processCheckOut(todayRecord, null, null, time);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                // ì¼ë°˜ ì§ì›ì€ ìœ„ì¹˜ ì •ë³´ ì—†ì´ í‡´ê·¼
                processCheckOut(todayRecord, null, null, time);
            }
        }
        
        function processCheckOut(todayRecord, latitude, longitude, time) {
            todayRecord.checkOut = time;
            
            // GPS ì •ë³´ ì¶”ê°€ (ì˜ì—…íŒ€ë§Œ)
            if (latitude && longitude) {
                todayRecord.checkOutLocation = {
                    latitude: latitude,
                    longitude: longitude,
                    type: 'field',
                    timestamp: new Date().toISOString()
                };
                
                // ì—­ì§€ì˜¤ì½”ë”© ì‹œë„ (ë¹„ë™ê¸°)
                reverseGeocode(latitude, longitude).then(address => {
                    todayRecord.checkOutLocation.address = address;
                    saveData();
                }).catch(err => {
                    console.error('ì—­ì§€ì˜¤ì½”ë”© ì‹¤íŒ¨:', err);
                });
            } else if (!todayRecord.checkOutLocation) {
                todayRecord.checkOutLocation = {
                    type: 'office'
                };
            }
            
            saveData();
            checkTodayAttendance();
            
            const locationMsg = todayRecord.checkOutLocation && todayRecord.checkOutLocation.type === 'field' 
                ? '\nğŸ“ ì™¸ê·¼ ìœ„ì¹˜ ê¸°ë¡ë¨' 
                : '\nğŸ¢ íšŒì‚¬ í‡´ê·¼';
            
            alert(`âœ… í‡´ê·¼ ì™„ë£Œ!\nì‹œê°„: ${time}\nìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤!${locationMsg}`);
        }
        
        // ì—­ì§€ì˜¤ì½”ë”© í•¨ìˆ˜ (ì¢Œí‘œ â†’ ì£¼ì†Œ)
        async function reverseGeocode(lat, lng) {
            try {
                // Nominatim API (OpenStreetMap) ì‚¬ìš© - ë¬´ë£Œ
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=ko`,
                    {
                        headers: {
                            'User-Agent': 'DasolWaterLab/1.0'
                        }
                    }
                );
                const data = await response.json();
                
                if (data && data.address) {
                    const addr = data.address;
                    let address = '';
                    
                    if (addr.city || addr.province) {
                        address += (addr.city || addr.province) + ' ';
                    }
                    if (addr.suburb || addr.borough) {
                        address += (addr.suburb || addr.borough) + ' ';
                    }
                    if (addr.neighbourhood || addr.quarter) {
                        address += (addr.neighbourhood || addr.quarter);
                    }
                    
                    return address.trim() || data.display_name;
                }
                return 'ìœ„ì¹˜ ì •ë³´ ì—†ìŒ';
            } catch (error) {
                console.error('ì—­ì§€ì˜¤ì½”ë”© ì—ëŸ¬:', error);
                return `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
            }
        }

        function updateTodayStats() {
            const today = new Date().toISOString().split('T')[0];
            const todayAttendances = attendances.filter(a => a.date === today);
            
            const present = todayAttendances.filter(a => a.checkIn).length;
            const late = todayAttendances.filter(a => a.status === 'late').length;
            const todayVacations = vacations.filter(v => 
                v.status === 'approved' && v.startDate <= today && v.endDate >= today
            ).length;
            
            document.getElementById('todayPresent').textContent = present + 'ëª…';
            document.getElementById('todayAbsent').textContent = '0ëª…';
            document.getElementById('todayLate').textContent = late + 'ëª…';
            document.getElementById('todayVacation').textContent = todayVacations + 'ëª…';
            
            // í…Œì´ë¸” ë Œë”ë§
            const tbody = document.getElementById('todayAttendanceTable');
            tbody.innerHTML = todayAttendances.map(a => `
                <tr>
                    <td>${a.userName}</td>
                    <td>${a.userTeam}</td>
                    <td>${a.checkIn || '-'}</td>
                    <td>${a.checkOut || '-'}</td>
                    <td>
                        <span class="badge badge-${a.status === 'late' ? 'late' : 'present'}">
                            ${a.status === 'late' ? 'ì§€ê°' : 'ì¶œê·¼'}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        function openVacationModal() {
            document.getElementById('vacationModal').classList.add('show');
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('vacationStart').value = today;
            document.getElementById('vacationEnd').value = today;
            updateVacationDays();
        }

        function closeVacationModal() {
            document.getElementById('vacationModal').classList.remove('show');
            document.getElementById('vacationForm').reset();
        }

        function updateVacationDays() {
            const type = document.getElementById('vacationType').value;
            const start = new Date(document.getElementById('vacationStart').value);
            const end = new Date(document.getElementById('vacationEnd').value);
            
            if (!type || !start || !end) return;
            
            let days = 0;
            if (type === 'ë°˜ì°¨' || type === 'ë°˜ì°¨ì˜¤í›„') {
                days = 0.5;
            } else {
                days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
            }
            
            document.getElementById('requestDays').textContent = days + 'ì¼';
        }

        document.getElementById('vacationForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const vacation = {
                id: `VAC-${Date.now()}`,
                userId: currentUser.id,
                userName: currentUser.name,
                userTeam: currentUser.team,
                type: document.getElementById('vacationType').value,
                startDate: document.getElementById('vacationStart').value,
                endDate: document.getElementById('vacationEnd').value,
                days: parseFloat(document.getElementById('requestDays').textContent),
                reason: document.getElementById('vacationReason').value,
                status: 'pending',
                createdAt: new Date().toISOString()
            };
            
            vacations.push(vacation);
            saveData();
            closeVacationModal();
            alert('âœ… íœ´ê°€ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
            renderMyVacations();
        });

        function updateVacationInfo() {
            const myVacations = vacations.filter(v => 
                v.userId === currentUser.id && v.status === 'approved'
            );
            const used = myVacations.reduce((sum, v) => sum + v.days, 0);
            const total = 15; // ê¸°ë³¸ ì—°ì°¨
            
            document.getElementById('totalVacation').textContent = total + 'ì¼';
            document.getElementById('usedVacation').textContent = used + 'ì¼';
            document.getElementById('remainVacation').textContent = (total - used) + 'ì¼';
        }

        function renderMyVacations() {
            const myVacations = vacations.filter(v => v.userId === currentUser.id);
            const tbody = document.getElementById('myVacationsTable');
            
            tbody.innerHTML = myVacations.sort((a, b) => 
                new Date(b.createdAt) - new Date(a.createdAt)
            ).map(v => `
                <tr>
                    <td>${v.createdAt.split('T')[0]}</td>
                    <td>${v.type}</td>
                    <td>${v.startDate} ~ ${v.endDate}</td>
                    <td>${v.days}ì¼</td>
                    <td>${v.reason}</td>
                    <td>
                        <span class="badge badge-${v.status}">
                            ${v.status === 'pending' ? 'ëŒ€ê¸°' : v.status === 'approved' ? 'ìŠ¹ì¸' : 'ë°˜ë ¤'}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        function openOvertimeModal() {
            document.getElementById('overtimeModal').classList.add('show');
            document.getElementById('overtimeDate').value = new Date().toISOString().split('T')[0];
        }

        function closeOvertimeModal() {
            document.getElementById('overtimeModal').classList.remove('show');
            document.getElementById('overtimeForm').reset();
        }

        function calculateOvertimeHours() {
            const start = document.getElementById('overtimeStart').value;
            const end = document.getElementById('overtimeEnd').value;
            
            if (!start || !end) return;
            
            const startTime = new Date(`2000-01-01 ${start}`);
            const endTime = new Date(`2000-01-01 ${end}`);
            const hours = (endTime - startTime) / (1000 * 60 * 60);
            
            document.getElementById('overtimeHours').textContent = hours + 'ì‹œê°„';
        }

        document.getElementById('overtimeForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const overtime = {
                id: `OT-${Date.now()}`,
                userId: currentUser.id,
                userName: currentUser.name,
                userTeam: currentUser.team,
                date: document.getElementById('overtimeDate').value,
                startTime: document.getElementById('overtimeStart').value,
                endTime: document.getElementById('overtimeEnd').value,
                hours: parseFloat(document.getElementById('overtimeHours').textContent),
                reason: document.getElementById('overtimeReason').value,
                status: 'pending',
                createdAt: new Date().toISOString()
            };
            
            overtimes.push(overtime);
            saveData();
            closeOvertimeModal();
            alert('âœ… ì´ˆê³¼ê·¼ë¬´ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
            renderMyOvertime();
        });

        function renderMyOvertime() {
            const myOvertime = overtimes.filter(o => o.userId === currentUser.id);
            const tbody = document.getElementById('myOvertimeTable');
            
            tbody.innerHTML = myOvertime.sort((a, b) => 
                new Date(b.createdAt) - new Date(a.createdAt)
            ).map(o => `
                <tr>
                    <td>${o.createdAt.split('T')[0]}</td>
                    <td>${o.date}</td>
                    <td>${o.startTime}</td>
                    <td>${o.endTime}</td>
                    <td><strong>${o.hours}H</strong></td>
                    <td>${o.reason}</td>
                    <td>
                        <span class="badge badge-${o.status}">
                            ${o.status === 'pending' ? 'ëŒ€ê¸°' : o.status === 'approved' ? 'ìŠ¹ì¸' : 'ë°˜ë ¤'}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        function loadMonthlyRecords() {
            const month = document.getElementById('recordMonth').value;
            const myRecords = attendances.filter(a => 
                a.userId === currentUser.id && a.date.startsWith(month)
            );
            
            // í†µê³„
            const present = myRecords.filter(a => a.checkIn).length;
            const late = myRecords.filter(a => a.status === 'late').length;
            
            // ì´ ê·¼ë¬´ì‹œê°„ ê³„ì‚°
            const totalHours = myRecords.reduce((sum, a) => {
                if (a.checkIn && a.checkOut) {
                    const hours = calculateWorkHours(a.checkIn, a.checkOut);
                    return sum + hours;
                }
                return sum;
            }, 0);
            
            document.getElementById('monthlyPresent').textContent = present + 'ì¼';
            document.getElementById('monthlyLate').textContent = late + 'íšŒ';
            document.getElementById('monthlyHours').textContent = Math.round(totalHours) + 'H';
            document.getElementById('monthlyOvertime').textContent = '0H'; // TODO: ì´ˆê³¼ê·¼ë¬´ ê³„ì‚°
            
            // í…Œì´ë¸”
            const tbody = document.getElementById('monthlyRecordsTable');
            tbody.innerHTML = myRecords.sort((a, b) => 
                new Date(b.date) - new Date(a.date)
            ).map(a => {
                const workHours = a.checkIn && a.checkOut ? calculateWorkHours(a.checkIn, a.checkOut) : 0;
                const locationInfo = getLocationInfo(a);
                
                return `
                <tr>
                    <td>${a.date}</td>
                    <td>${a.checkIn || '-'}${locationInfo.checkIn}</td>
                    <td>${a.checkOut || '-'}${locationInfo.checkOut}</td>
                    <td>${workHours > 0 ? workHours.toFixed(1) + 'H' : '-'}</td>
                    <td>
                        <span class="badge badge-${a.status === 'late' ? 'late' : 'present'}">
                            ${a.status === 'late' ? 'ì§€ê°' : 'ì¶œê·¼'}
                        </span>
                    </td>
                </tr>
            `}).join('');
        }
        
        // ê·¼ë¬´ì‹œê°„ ê³„ì‚° í•¨ìˆ˜
        function calculateWorkHours(checkIn, checkOut) {
            if (!checkIn || !checkOut) return 0;
            
            const [inHour, inMin] = checkIn.split(':').map(Number);
            const [outHour, outMin] = checkOut.split(':').map(Number);
            
            const inMinutes = inHour * 60 + inMin;
            const outMinutes = outHour * 60 + outMin;
            
            return (outMinutes - inMinutes) / 60;
        }
        
        // ìœ„ì¹˜ ì •ë³´ í‘œì‹œ í•¨ìˆ˜
        function getLocationInfo(attendance) {
            let checkIn = '';
            let checkOut = '';
            
            if (attendance.checkInLocation) {
                if (attendance.checkInLocation.type === 'field') {
                    const addr = attendance.checkInLocation.address || 'ì™¸ê·¼';
                    checkIn = `<br><small style="color: #3b82f6;">ğŸ“ ${addr}</small>`;
                } else {
                    checkIn = '<br><small style="color: #6b7280;">ğŸ¢ íšŒì‚¬</small>';
                }
            }
            
            if (attendance.checkOutLocation) {
                if (attendance.checkOutLocation.type === 'field') {
                    const addr = attendance.checkOutLocation.address || 'ì™¸ê·¼';
                    checkOut = `<br><small style="color: #3b82f6;">ğŸ“ ${addr}</small>`;
                } else {
                    checkOut = '<br><small style="color: #6b7280;">ğŸ¢ íšŒì‚¬</small>';
                }
            }
            
            return { checkIn, checkOut };
        }

        function renderPendingApprovals() {
            if (!currentUser.isAdmin) return;
            
            const pendingVacations = vacations.filter(v => v.status === 'pending');
            const pendingOvertimes = overtimes.filter(o => o.status === 'pending');
            
            const tbody = document.getElementById('pendingApprovalsTable');
            const items = [
                ...pendingVacations.map(v => ({ ...v, type: 'vacation' })),
                ...pendingOvertimes.map(o => ({ ...o, type: 'overtime' }))
            ].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            tbody.innerHTML = items.map(item => `
                <tr>
                    <td>${item.createdAt.split('T')[0]}</td>
                    <td>${item.type === 'vacation' ? 'íœ´ê°€' : 'ì´ˆê³¼ê·¼ë¬´'}</td>
                    <td>${item.userName}</td>
                    <td>${item.userTeam}</td>
                    <td>${item.type === 'vacation' ? item.type : item.reason}</td>
                    <td>${item.type === 'vacation' ? 
                        `${item.startDate} ~ ${item.endDate} (${item.days}ì¼)` :
                        `${item.startTime} ~ ${item.endTime} (${item.hours}H)`
                    }</td>
                    <td>
                        <button class="btn btn-success" onclick="approveItem('${item.type}', '${item.id}')" style="padding: 6px 12px; font-size: 12px;">ìŠ¹ì¸</button>
                        <button class="btn btn-danger" onclick="rejectItem('${item.type}', '${item.id}')" style="padding: 6px 12px; font-size: 12px;">ë°˜ë ¤</button>
                    </td>
                </tr>
            `).join('');
        }

        function approveItem(type, id) {
            if (!confirm('ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            if (type === 'vacation') {
                const vacation = vacations.find(v => v.id === id);
                if (vacation) {
                    vacation.status = 'approved';
                    vacation.approvedBy = currentUser.name;
                    vacation.approvedAt = new Date().toISOString();
                }
            } else {
                const overtime = overtimes.find(o => o.id === id);
                if (overtime) {
                    overtime.status = 'approved';
                    overtime.approvedBy = currentUser.name;
                    overtime.approvedAt = new Date().toISOString();
                }
            }
            
            saveData();
            renderPendingApprovals();
            alert('âœ… ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        function rejectItem(type, id) {
            const reason = prompt('ë°˜ë ¤ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
            if (!reason) return;
            
            if (type === 'vacation') {
                const vacation = vacations.find(v => v.id === id);
                if (vacation) {
                    vacation.status = 'rejected';
                    vacation.rejectedBy = currentUser.name;
                    vacation.rejectedAt = new Date().toISOString();
                    vacation.rejectReason = reason;
                }
            } else {
                const overtime = overtimes.find(o => o.id === id);
                if (overtime) {
                    overtime.status = 'rejected';
                    overtime.rejectedBy = currentUser.name;
                    overtime.rejectedAt = new Date().toISOString();
                    overtime.rejectReason = reason;
                }
            }
            
            saveData();
            renderPendingApprovals();
            alert('âœ… ë°˜ë ¤ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        // ë‹¬ë ¥ ì—°ë™ í•¨ìˆ˜
        function syncCalendar() {
            const approvedVacations = vacations.filter(v => v.status === 'approved');
            
            // ë‹¬ë ¥ ë°ì´í„° êµ¬ì¡° ìƒì„±
            const calendarData = [];
            
            approvedVacations.forEach(vacation => {
                const start = new Date(vacation.startDate);
                const end = new Date(vacation.endDate);
                
                // ë‚ ì§œ ë²”ìœ„ ë‚´ ëª¨ë“  ë‚ ì§œ ìƒì„±
                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    const dateStr = d.toISOString().split('T')[0];
                    
                    let existing = calendarData.find(c => c.date === dateStr);
                    if (!existing) {
                        existing = {
                            date: dateStr,
                            type: 'vacation',
                            employees: []
                        };
                        calendarData.push(existing);
                    }
                    
                    existing.employees.push({
                        id: vacation.userId,
                        name: vacation.userName,
                        team: vacation.userTeam,
                        vacationType: vacation.type,
                        duration: vacation.type.includes('ë°˜ì°¨') ? 'ë°˜ì°¨' : 'ì „ì¼',
                        reason: vacation.reason,
                        status: 'approved'
                    });
                }
            });
            
            // ë‹¬ë ¥ì— ì €ì¥
            localStorage.setItem('dasol_attendance_calendar', JSON.stringify(calendarData));
        }
        
        // ì „ì²´ ì§ì› ê·¼íƒœí‘œ ìƒì„± (ê´€ë¦¬ì ì „ìš©)
        function generateAllEmployeeReport() {
            if (!currentUser.isAdmin) {
                alert('âš ï¸ ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }
            
            const monthInput = document.getElementById('allEmployeeMonth');
            const month = monthInput ? monthInput.value : document.getElementById('recordMonth').value;
            
            if (!month) {
                alert('âš ï¸ ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const [year, monthNum] = month.split('-');
            const monthName = `${year}ë…„ ${parseInt(monthNum)}ì›”`;
            
            // í•´ë‹¹ ì›”ì˜ ëª¨ë“  ì§ì› ê·¼íƒœ ë°ì´í„° ìˆ˜ì§‘
            const allRecords = attendances.filter(a => a.date.startsWith(month));
            
            // ì§ì›ë³„ë¡œ ë°ì´í„° ê·¸ë£¹í™”
            const employeeGroups = {};
            allRecords.forEach(record => {
                if (!employeeGroups[record.userId]) {
                    employeeGroups[record.userId] = {
                        userId: record.userId,
                        userName: record.userName,
                        userTeam: record.userTeam,
                        records: []
                    };
                }
                employeeGroups[record.userId].records.push(record);
            });
            
            // ì§ì› ëª©ë¡ ìƒì„±
            const employees = Object.values(employeeGroups);
            
            if (employees.length === 0) {
                alert('âš ï¸ í•´ë‹¹ ì›”ì— ì¶œí‡´ê·¼ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ë¶€ì„œë³„ë¡œ ì •ë ¬
            employees.sort((a, b) => {
                if (a.userTeam === b.userTeam) {
                    return a.userName.localeCompare(b.userName);
                }
                return a.userTeam.localeCompare(b.userTeam);
            });
            
            // ì „ì²´ ì§ì› ê·¼íƒœí‘œ HTML ìƒì„±
            const employeeSections = employees.map(emp => {
                const records = emp.records.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                // í†µê³„ ê³„ì‚°
                const totalDays = records.length;
                const normalDays = records.filter(r => r.status === 'present').length;
                const lateDays = records.filter(r => r.status === 'late').length;
                const totalHours = records.reduce((sum, r) => {
                    if (r.checkIn && r.checkOut) {
                        return sum + calculateWorkHours(r.checkIn, r.checkOut);
                    }
                    return sum;
                }, 0);
                
                // íœ´ê°€ ë°ì´í„°
                const empVacations = vacations.filter(v => 
                    v.userId === emp.userId && 
                    v.status === 'approved' &&
                    v.startDate.startsWith(month)
                );
                const vacationDays = empVacations.reduce((sum, v) => sum + v.days, 0);
                
                return `
                    <div class="employee-section">
                        <div class="employee-header">
                            <span class="employee-name">${emp.userName}</span>
                            <span class="employee-team">${emp.userTeam}</span>
                        </div>
                        
                        <div class="employee-stats">
                            <div class="stat-item">
                                <span class="stat-label">ì¶œê·¼ì¼ìˆ˜</span>
                                <span class="stat-value">${totalDays}ì¼</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">ì •ìƒ</span>
                                <span class="stat-value">${normalDays}ì¼</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">ì§€ê°</span>
                                <span class="stat-value">${lateDays}ì¼</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">íœ´ê°€</span>
                                <span class="stat-value">${vacationDays}ì¼</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">ì´ ê·¼ë¬´ì‹œê°„</span>
                                <span class="stat-value">${Math.round(totalHours)}ì‹œê°„</span>
                            </div>
                        </div>
                        
                        <table class="detail-table">
                            <thead>
                                <tr>
                                    <th style="width: 80px;">ë‚ ì§œ</th>
                                    <th style="width: 60px;">ì¶œê·¼</th>
                                    <th style="width: 60px;">í‡´ê·¼</th>
                                    <th style="width: 60px;">ê·¼ë¬´</th>
                                    <th style="width: 60px;">ìƒíƒœ</th>
                                    <th>ë¹„ê³ </th>
                                </tr>
                            </thead>
                            <tbody>
                                ${records.map(r => {
                                    const workHours = r.checkIn && r.checkOut ? calculateWorkHours(r.checkIn, r.checkOut) : 0;
                                    const vacation = empVacations.find(v => 
                                        r.date >= v.startDate && r.date <= v.endDate
                                    );
                                    const locationInfo = getLocationInfo(r);
                                    
                                    return `
                                    <tr>
                                        <td>${r.date.substring(5)}</td>
                                        <td>${r.checkIn || '-'}</td>
                                        <td>${r.checkOut || '-'}</td>
                                        <td>${workHours > 0 ? workHours.toFixed(1) + 'H' : '-'}</td>
                                        <td><span class="status-badge ${vacation ? 'vacation' : r.status}">${vacation ? 'íœ´ê°€' : (r.status === 'late' ? 'ì§€ê°' : 'ì •ìƒ')}</span></td>
                                        <td style="font-size: 11px;">${vacation ? vacation.type : (locationInfo.checkIn ? 'ì™¸ê·¼' : '')}</td>
                                    </tr>
                                `}).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }).join('');
            
            // ì „ì²´ í†µê³„ ê³„ì‚°
            const totalEmployees = employees.length;
            const totalWorkDays = employees.reduce((sum, emp) => sum + emp.records.length, 0);
            const totalWorkHours = employees.reduce((sum, emp) => {
                return sum + emp.records.reduce((s, r) => {
                    if (r.checkIn && r.checkOut) {
                        return s + calculateWorkHours(r.checkIn, r.checkOut);
                    }
                    return s;
                }, 0);
            }, 0);
            const totalLate = allRecords.filter(r => r.status === 'late').length;
            const avgAttendance = totalEmployees > 0 ? ((totalWorkDays / totalEmployees) / getDaysInMonth(year, monthNum) * 100).toFixed(1) : 0;
            
            // HTML ìƒì„±
            const html = `
                <!DOCTYPE html>
                <html lang="ko">
                <head>
                    <meta charset="UTF-8">
                    <title>ì „ì²´ ì§ì› ê·¼íƒœí‘œ - ${monthName}</title>
                    <style>
                        @page { size: A4; margin: 15mm; }
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body {
                            font-family: 'Malgun Gothic', 'Noto Sans KR', sans-serif;
                            padding: 20px;
                            line-height: 1.4;
                            font-size: 12px;
                        }
                        .title {
                            text-align: center;
                            font-size: 28px;
                            font-weight: 700;
                            margin-bottom: 30px;
                            padding-bottom: 12px;
                            border-bottom: 3px double #000;
                            letter-spacing: 6px;
                        }
                        .summary-box {
                            border: 2px solid #000;
                            padding: 15px;
                            margin-bottom: 25px;
                            background: #f9f9f9;
                        }
                        .summary-grid {
                            display: grid;
                            grid-template-columns: repeat(4, 1fr);
                            gap: 15px;
                        }
                        .summary-item {
                            text-align: center;
                        }
                        .summary-label {
                            font-size: 11px;
                            color: #666;
                            margin-bottom: 5px;
                        }
                        .summary-value {
                            font-size: 20px;
                            font-weight: 700;
                            color: #667eea;
                        }
                        .employee-section {
                            page-break-inside: avoid;
                            margin-bottom: 25px;
                            border: 1px solid #ddd;
                            border-radius: 8px;
                            overflow: hidden;
                        }
                        .employee-header {
                            background: #667eea;
                            color: white;
                            padding: 12px 15px;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        }
                        .employee-name {
                            font-size: 16px;
                            font-weight: 700;
                        }
                        .employee-team {
                            font-size: 13px;
                            opacity: 0.9;
                        }
                        .employee-stats {
                            display: grid;
                            grid-template-columns: repeat(5, 1fr);
                            background: #f5f5f5;
                            padding: 10px;
                            gap: 10px;
                        }
                        .stat-item {
                            text-align: center;
                        }
                        .stat-label {
                            font-size: 10px;
                            color: #666;
                            display: block;
                            margin-bottom: 3px;
                        }
                        .stat-value {
                            font-size: 14px;
                            font-weight: 700;
                            color: #333;
                        }
                        .detail-table {
                            width: 100%;
                            border-collapse: collapse;
                        }
                        .detail-table th {
                            background: #f9f9f9;
                            padding: 8px 5px;
                            text-align: center;
                            font-size: 11px;
                            border: 1px solid #ddd;
                        }
                        .detail-table td {
                            padding: 6px 5px;
                            text-align: center;
                            font-size: 10px;
                            border: 1px solid #ddd;
                        }
                        .status-badge {
                            display: inline-block;
                            padding: 2px 6px;
                            border-radius: 4px;
                            font-size: 10px;
                            font-weight: 600;
                        }
                        .status-badge.present {
                            background: #d1fae5;
                            color: #065f46;
                        }
                        .status-badge.late {
                            background: #fef3c7;
                            color: #92400e;
                        }
                        .status-badge.vacation {
                            background: #dbeafe;
                            color: #1e40af;
                        }
                        .footer {
                            margin-top: 30px;
                            text-align: center;
                            padding-top: 20px;
                            border-top: 2px solid #000;
                        }
                        .company-info {
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 15px;
                            margin-bottom: 10px;
                        }
                        .logo-container {
                            width: 60px;
                            height: 60px;
                        }
                        .logo-container img {
                            width: 100%;
                            height: 100%;
                            object-fit: contain;
                        }
                        .company-details {
                            text-align: left;
                            font-size: 11px;
                            line-height: 1.6;
                        }
                        .company-name {
                            font-size: 14px;
                            font-weight: 700;
                            margin-bottom: 3px;
                        }
                        .stamp-container {
                            position: absolute;
                            top: 30px;
                            right: 30px;
                            width: 80px;
                            height: 80px;
                        }
                        .stamp-container img {
                            width: 100%;
                            height: 100%;
                            object-fit: contain;
                        }
                        @media print {
                            .no-print { display: none; }
                            body { padding: 0; }
                        }
                    </style>
                </head>
                <body>
                    <div class="stamp-container">
                        <img src="../assets/stamp-transparent.png" alt="ì‚¬ê°ë„ì¥" />
                    </div>
                    
                    <div class="title">ì „ì²´ ì§ì› ê·¼íƒœí‘œ</div>
                    <div style="text-align: center; font-size: 18px; font-weight: 700; margin-bottom: 25px; color: #667eea;">${monthName}</div>
                    
                    <div class="summary-box">
                        <div class="summary-grid">
                            <div class="summary-item">
                                <div class="summary-label">ì „ì²´ ì§ì›</div>
                                <div class="summary-value">${totalEmployees}ëª…</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">ì´ ê·¼ë¬´ì¼</div>
                                <div class="summary-value">${totalWorkDays}ì¼</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">ì´ ê·¼ë¬´ì‹œê°„</div>
                                <div class="summary-value">${Math.round(totalWorkHours)}H</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">í‰ê·  ì¶œê·¼ìœ¨</div>
                                <div class="summary-value">${avgAttendance}%</div>
                            </div>
                        </div>
                    </div>
                    
                    ${employeeSections}
                    
                    <div class="footer">
                        <div class="company-info">
                            <div class="logo-container">
                                <img src="../assets/logo.png" alt="ë‹¤ì†”ë¬¼í™˜ê²½ì—°êµ¬ì†Œ ë¡œê³ " />
                            </div>
                            <div class="company-details">
                                <div class="company-name">ì£¼ì‹íšŒì‚¬ ë‹¤ì†”ë¬¼í™˜ê²½ì—°êµ¬ì†Œ</div>
                                <div>ê²½ê¸°ë„ í•˜ë‚¨ì‹œ ì´ˆê´‘ì‚°ë‹¨ë¡œ 126, ìš°ì¼ë¹Œë”© 3ì¸µ</div>
                                <div>Tel. 031-772-4530 | Fax. 031-775-4539</div>
                            </div>
                        </div>
                        <div style="margin-top: 15px; font-size: 11px; color: #6b7280;">
                            ì‘ì„±ì¼: ${new Date().toLocaleDateString('ko-KR')}
                        </div>
                    </div>
                    
                    <div class="no-print" style="margin-top: 25px; text-align: center;">
                        <button onclick="window.print()" style="padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; margin-right: 10px; font-weight: 600;">ğŸ–¨ï¸ ì¸ì‡„</button>
                        <button onclick="window.close()" style="padding: 12px 24px; background: #6b7280; color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; font-weight: 600;">ë‹«ê¸°</button>
                    </div>
                </body>
                </html>
            `;
            
            // ìƒˆ ì°½ì—ì„œ ì—´ê¸°
            const printWindow = window.open('', '_blank');
            printWindow.document.write(html);
            printWindow.document.close();
        }
        
        // í•´ë‹¹ ì›”ì˜ ì¼ìˆ˜ ê³„ì‚°
        function getDaysInMonth(year, month) {
            return new Date(year, month, 0).getDate();
        }
        
        // ê·¼íƒœê³„ PDF ìƒì„±
        function generateAttendanceReport() {
            const month = document.getElementById('recordMonth').value;
            if (!month) {
                alert('âš ï¸ ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const [year, monthNum] = month.split('-');
            const monthName = `${year}ë…„ ${parseInt(monthNum)}ì›”`;
            
            // í•´ë‹¹ ì›”ì˜ ê·¼íƒœ ë°ì´í„° ìˆ˜ì§‘
            const myRecords = attendances.filter(a => 
                a.userId === currentUser.id && a.date.startsWith(month)
            );
            
            // íœ´ê°€ ë°ì´í„°
            const myVacations = vacations.filter(v => 
                v.userId === currentUser.id && 
                v.status === 'approved' &&
                v.startDate.startsWith(month)
            );
            
            // í†µê³„ ê³„ì‚°
            const totalDays = myRecords.length;
            const normalDays = myRecords.filter(a => a.status === 'present').length;
            const lateDays = myRecords.filter(a => a.status === 'late').length;
            const vacationDays = myVacations.reduce((sum, v) => sum + v.days, 0);
            const totalHours = myRecords.reduce((sum, a) => {
                if (a.checkIn && a.checkOut) {
                    return sum + calculateWorkHours(a.checkIn, a.checkOut);
                }
                return sum;
            }, 0);
            
            // ê·¼íƒœê³„ HTML ìƒì„±
            const html = `
                <!DOCTYPE html>
                <html lang="ko">
                <head>
                    <meta charset="UTF-8">
                    <title>ê·¼íƒœê³„ - ${currentUser.name} (${monthName})</title>
                    <style>
                        @page { size: A4; margin: 20mm; }
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body {
                            font-family: 'Malgun Gothic', 'Noto Sans KR', sans-serif;
                            padding: 30px;
                            line-height: 1.6;
                        }
                        .title {
                            text-align: center;
                            font-size: 32px;
                            font-weight: 700;
                            margin-bottom: 40px;
                            padding-bottom: 15px;
                            border-bottom: 4px double #000;
                            letter-spacing: 8px;
                        }
                        .info-box {
                            border: 2px solid #000;
                            padding: 20px;
                            margin-bottom: 30px;
                        }
                        .info-row {
                            display: grid;
                            grid-template-columns: 120px 1fr;
                            margin-bottom: 12px;
                            font-size: 14px;
                        }
                        .info-label {
                            font-weight: 700;
                            background: #f9f9f9;
                            padding: 8px 12px;
                            border-right: 2px solid #ddd;
                        }
                        .info-value {
                            padding: 8px 12px;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 20px 0;
                            border: 2px solid #000;
                        }
                        th, td {
                            border: 1px solid #000;
                            padding: 10px;
                            text-align: center;
                            font-size: 13px;
                        }
                        th {
                            background: #f0f0f0;
                            font-weight: 700;
                        }
                        .summary-box {
                            border: 2px solid #000;
                            padding: 20px;
                            margin-top: 30px;
                        }
                        .summary-row {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 10px;
                            font-size: 15px;
                        }
                        .summary-row.total {
                            font-size: 18px;
                            font-weight: 700;
                            color: #667eea;
                            border-top: 2px solid #000;
                            padding-top: 15px;
                            margin-top: 15px;
                        }
                        .footer {
                            margin-top: 50px;
                            text-align: center;
                            padding-top: 30px;
                            border-top: 2px solid #000;
                        }
                        .company-info {
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 20px;
                            margin-bottom: 15px;
                        }
                        .logo-container {
                            width: 80px;
                            height: 80px;
                        }
                        .logo-container img {
                            width: 100%;
                            height: 100%;
                            object-fit: contain;
                        }
                        .company-details {
                            text-align: left;
                            font-size: 13px;
                            line-height: 1.8;
                        }
                        .company-name {
                            font-size: 18px;
                            font-weight: 700;
                            margin-bottom: 5px;
                        }
                        .stamp-container {
                            position: absolute;
                            top: 50px;
                            right: 50px;
                            width: 100px;
                            height: 100px;
                        }
                        .stamp-container img {
                            width: 100%;
                            height: 100%;
                            object-fit: contain;
                        }
                        @media print {
                            .no-print { display: none; }
                            body { padding: 0; }
                        }
                    </style>
                </head>
                <body>
                    <div class="stamp-container">
                        <img src="../assets/stamp-transparent.png" alt="ì‚¬ê°ë„ì¥" />
                    </div>
                    
                    <div class="title">ê·¼ íƒœ ê³„</div>
                    
                    <div class="info-box">
                        <div class="info-row">
                            <div class="info-label">ë¶€ ì„œ</div>
                            <div class="info-value">${currentUser.team || '-'}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">ì„± ëª…</div>
                            <div class="info-value">${currentUser.name}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">ì§ ê¸‰</div>
                            <div class="info-value">${currentUser.position || '-'}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">ëŒ€ìƒ ê¸°ê°„</div>
                            <div class="info-value">${monthName}</div>
                        </div>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 100px;">ë‚ ì§œ</th>
                                <th style="width: 80px;">ì¶œê·¼</th>
                                <th style="width: 80px;">í‡´ê·¼</th>
                                <th style="width: 80px;">ê·¼ë¬´ì‹œê°„</th>
                                <th style="width: 100px;">ìƒíƒœ</th>
                                <th>ë¹„ê³ </th>
                            </tr>
                        </thead>
                        <tbody>
                            ${myRecords.sort((a, b) => new Date(a.date) - new Date(b.date)).map(a => {
                                const workHours = a.checkIn && a.checkOut ? calculateWorkHours(a.checkIn, a.checkOut) : 0;
                                const vacation = myVacations.find(v => 
                                    a.date >= v.startDate && a.date <= v.endDate
                                );
                                const locationInfo = getLocationInfo(a);
                                
                                return `
                                <tr>
                                    <td>${a.date}</td>
                                    <td>${a.checkIn || '-'}</td>
                                    <td>${a.checkOut || '-'}</td>
                                    <td>${workHours > 0 ? workHours.toFixed(1) + 'H' : '-'}</td>
                                    <td>${vacation ? 'íœ´ê°€' : (a.status === 'late' ? 'ì§€ê°' : 'ì •ìƒ')}</td>
                                    <td style="font-size: 11px;">${vacation ? vacation.type : (locationInfo.checkIn ? 'ì™¸ê·¼' : '')}</td>
                                </tr>
                            `}).join('')}
                        </tbody>
                    </table>
                    
                    <div class="summary-box">
                        <h3 style="margin-bottom: 15px; font-size: 16px;">ğŸ“Š ì›”ë³„ í†µê³„</h3>
                        <div class="summary-row">
                            <span>ì´ ê·¼ë¬´ì¼</span>
                            <strong>${totalDays}ì¼</strong>
                        </div>
                        <div class="summary-row">
                            <span>ì •ìƒ ì¶œê·¼</span>
                            <strong>${normalDays}ì¼</strong>
                        </div>
                        <div class="summary-row">
                            <span>ì§€ê°</span>
                            <strong>${lateDays}ì¼</strong>
                        </div>
                        <div class="summary-row">
                            <span>ê²°ê·¼</span>
                            <strong>0ì¼</strong>
                        </div>
                        <div class="summary-row">
                            <span>ì—°ì°¨ ì‚¬ìš©</span>
                            <strong>${vacationDays}ì¼</strong>
                        </div>
                        <div class="summary-row total">
                            <span>ì´ ê·¼ë¬´ì‹œê°„</span>
                            <strong>${Math.round(totalHours)}ì‹œê°„</strong>
                        </div>
                    </div>
                    
                    <div class="footer">
                        <div class="company-info">
                            <div class="logo-container">
                                <img src="../assets/logo.png" alt="ë‹¤ì†”ë¬¼í™˜ê²½ì—°êµ¬ì†Œ ë¡œê³ " />
                            </div>
                            <div class="company-details">
                                <div class="company-name">ì£¼ì‹íšŒì‚¬ ë‹¤ì†”ë¬¼í™˜ê²½ì—°êµ¬ì†Œ</div>
                                <div>ê²½ê¸°ë„ í•˜ë‚¨ì‹œ ì´ˆê´‘ì‚°ë‹¨ë¡œ 126, ìš°ì¼ë¹Œë”© 3ì¸µ</div>
                                <div>Tel. 031-772-4530 | Fax. 031-775-4539</div>
                            </div>
                        </div>
                        <div style="margin-top: 20px; font-size: 13px; color: #6b7280;">
                            ì‘ì„±ì¼: ${new Date().toLocaleDateString('ko-KR')}
                        </div>
                    </div>
                    
                    <div class="no-print" style="margin-top: 30px; text-align: center;">
                        <button onclick="window.print()" style="padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; margin-right: 10px; font-weight: 600;">ğŸ–¨ï¸ ì¸ì‡„</button>
                        <button onclick="window.close()" style="padding: 12px 24px; background: #6b7280; color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; font-weight: 600;">ë‹«ê¸°</button>
                    </div>
                </body>
                </html>
            `;
            
            // ìƒˆ ì°½ì—ì„œ ì—´ê¸°
            const printWindow = window.open('', '_blank');
            printWindow.document.write(html);
            printWindow.document.close();
        }
    </script>
</body>
</html>
